<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î™®Î∞îÏùº Í≤¨Ï†ÅÏÑú_0526_33_ÌÜµÌï©</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .custom-orange { color: #000; }
        .bg-custom-orange { background-color: #e1e1e1; color: #000; }
        .border-custom-orange { border-color: #ff5a00; }
        .custom-green { color: #66bb6a; }
        .bg-custom-green { background-color: #66bb6a; }
        .border-custom-green { border-color: #66bb6a; }
        @media print { body { width: 100%; margin: 0; padding: 0; } }
        .mb-8 { margin-bottom: 1rem; }
        .w-2\/10 { width: 20%; }
        .w-3\/10 { width: 34%; }
        .w-4\/10 { width: 40%; }

        .quote-group-section {
            border-width: 2px;
            border-style: solid;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 8px;
            background-color: #f9f9f9;
            position: relative;
            padding-top: 4rem;
        }

        .group-action-buttons {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }

        .group-action-buttons button {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            line-height: 1;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }
        .copy-quote-group-btn { background-color: #ffc107; color: #212529 !important; }
        .copy-quote-group-btn:hover { background-color: #e0a800; }
        .delete-quote-group-btn { background-color: #dc3545; }
        .delete-quote-group-btn:hover { background-color: #c82333; }

        .dynamic-section {
            border: 1px dashed #ccc;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 5px;
            background-color: #fdfdfd;
            position: relative;
        }
        .delete-dynamic-section-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            line-height: 1;
            z-index: 10;
            color: #ef4444;
        }
        .delete-dynamic-section-btn:hover {
            color: #dc2626;
        }

        [contenteditable][placeholder]:empty:before {
            content: attr(placeholder);
            color: #a0aec0;
            pointer-events: none;
            display: block;
        }

        .group-title-input {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        /* --- ÏÉÅÏÑ∏ ÏùºÏ†ïÌëú UI Ïä§ÌÉÄÏùº --- */
        .itinerary-planner-styles .action-button-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            color: white;
        }
        .itinerary-planner-styles .action-button-sm:hover {
            filter: brightness(0.95);
        }
        .itinerary-planner-styles .action-button-sm .fas {
            width: 14px;
            height: 14px;
            margin-right: 4px;
        }

        .itinerary-planner-styles .day-section {
            margin-bottom: 16px;
            border: 1px solid #E0E0E0;
            border-radius: 0.375rem;
            background-color: #ffffff;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .itinerary-planner-styles .day-header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px;
            border-bottom: 1px solid #EEE;
            background-color: #fdfdfd;
            border-radius: 6px 6px 0 0;
            cursor: grab;
        }
        .itinerary-planner-styles .day-header-main {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
        }
        .itinerary-planner-styles .day-header-title {
            font-size: 18px;
            font-weight: 600;
        }
        .itinerary-planner-styles .date-edit-input {
            font-size: 16px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            max-width: 220px;
        }
        .itinerary-planner-styles .day-header-controls {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .itinerary-planner-styles .icon-button {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
        }
        .itinerary-planner-styles .icon-button:hover {
            background-color: #e0e0e0;
        }
        .itinerary-planner-styles .icon-button .fas {
            font-size: 1rem;
        }
         .itinerary-planner-styles .icon-button.delete-detailed-day-button .fas {
            color: #ef4444;
        }
        .itinerary-planner-styles .icon-button.delete-detailed-day-button:hover .fas {
            color: #dc2626;
        }
        .itinerary-planner-styles .day-content-wrapper {
            padding: 0 8px 8px 8px;
        }
        .itinerary-planner-styles .activity-card {
            background-color: white;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            padding: 16px;
            margin-top: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            cursor: grab;
        }
        .itinerary-planner-styles .activities-list .activity-card:first-child {
            margin-top: 8px;
        }
        .itinerary-planner-styles .card-time-icon-area {
            width: 100px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        .itinerary-planner-styles .card-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        .itinerary-planner-styles .card-time {
            font-size: 14px;
            font-weight: bold;
            min-height: 21px;
        }
        .itinerary-planner-styles .card-details-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .itinerary-planner-styles .card-title {
            font-size: 16px;
            font-weight: bold;
        }
        .itinerary-planner-styles .card-description,
        .itinerary-planner-styles .card-location,
        .itinerary-planner-styles .card-cost,
        .itinerary-planner-styles .card-notes {
            font-size: 14px;
            color: #374151;
        }
        .itinerary-planner-styles .card-image {
            width: 150px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 8px;
        }
        .itinerary-planner-styles .card-location a {
            color: #007bff;
            text-decoration: none;
        }
        .itinerary-planner-styles .card-location a:hover {
            text-decoration: underline;
        }
         .itinerary-planner-styles .card-actions-direct {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            margin-left: auto;
            padding-left: 0.5rem;
        }
        .itinerary-planner-styles .card-actions-direct .icon-button .fas {
            font-size: 0.875rem;
        }
        /* Modal Styles */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 24px; border-radius: 8px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-content label { display: block; margin-bottom: 4px; font-weight: 500; }
        .modal-content input, .modal-content textarea, .modal-content select {
            width: 100%; padding: 8px; border: 1px solid #ccc;
            border-radius: 4px; margin-bottom: 12px; background-color: white; height: 40px;
        }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 8px; margin-top: 16px; }
        #toast {
            position: fixed; bottom: 20px; right: 20px; background-color: #333; color: white;
            padding: 10px 20px; border-radius: 5px; z-index: 1050; opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        #toast.show { opacity: 1; }

        .action-button {
            padding: 8px 12px;
            font-size: 0.875rem;
            border-radius: 6px;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: #14B8A6;
            color: white;
            border: none;
        }
        .action-button:hover {
            background-color: #0D9488;
            filter: brightness(0.95);
        }

        /* --- ReadOnly, Print, Sortable Styles --- */
        .readonly-view-header {
            background-color: white;
            border-bottom: 1px solid #E0E0E0;
            padding: 1rem;
            text-align: center;
        }
        .readonly-view-header h1 {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .readonly-main-content {
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
            padding: 1rem;
        }
        .readonly-activity-card {
            background-color: white;
            border-radius: 8px;
            border: 1px solid #E0E0E0;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
        }
        .readonly-collapse-button {
            font-size: 0.75rem;
            color: #4B5563;
            padding: 0.25rem 0.5rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .readonly-collapse-button:hover {
            color: #1F2937;
            background-color: #F3F4F6;
        }
        .day-header-container[onclick] { cursor: pointer; }
        .day-header-container[onclick]:hover { background-color: #f0f0f0; }


        .itinerary-planner-styles .day-section.sortable-ghost {
            background-color: #e0e7ff !important;
            border: 2px dashed #6366f1 !important;
            opacity: 0.6;
        }
        .itinerary-planner-styles .activity-card.sortable-ghost {
            background-color: #f0f9ff !important;
            border: 1px dashed #38bdf8 !important;
            opacity: 0.6;
        }
        .itinerary-planner-styles .day-section.sortable-chosen,
        .itinerary-planner-styles .activity-card.sortable-chosen {
            opacity: 0.7;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .itinerary-planner-styles .activity-card:active,
        .itinerary-planner-styles .day-header-container:active {
            cursor: grabbing;
        }


        /* --- Print and Saved HTML View Specific Styles --- */
        @media print, .saved-html-view {
            .group-action-buttons, .add-price-subgroup-button, .add-flight-subgroup-button, .add-itinerary-row-to-group,
            .load-detailed-itinerary-html-btn, .load-detailed-itinerary-excel-btn, .add-detailed-itinerary-day-button,
            .delete-dynamic-section-btn, .delete-row, .add-price-row-to-subgroup, .add-flight-row-to-subgroup,
            #activityModal, .modal-backdrop,
            .edit-detailed-date-button, .save-detailed-date-button, .cancel-detailed-date-edit-button,
            .load-detailed-day-html-button, .card-actions-direct,
            #addGlobalQuoteGroupBtn, footer button, footer input, /* Global buttons and footer interactive elements */
            .itinerary-planner-styles .edit-detailed-date-button,
            .itinerary-planner-styles .save-detailed-date-button,
            .itinerary-planner-styles .cancel-detailed-date-edit-button,
            .itinerary-planner-styles .load-detailed-day-html-button,
            .itinerary-planner-styles .card-actions-direct,
            .itinerary-planner-styles .add-activity-to-day-button,
            .itinerary-planner-styles .delete-detailed-day-button,
            .itinerary-planner-styles .date-edit-input,
            .itinerary-planner-styles .save-detailed-itinerary-html-btn, /* Hide data save/load buttons */
            .itinerary-planner-styles .save-detailed-day-html-btn,
            .itinerary-detail-section-wrapper .itinerary-planner-styles .action-button-sm /* Hide all buttons in itinerary header for print/saved */
            { display: none !important; }

            /* Keep toggle button visible in saved-html-view but not print */
            .saved-html-view .itinerary-planner-styles .toggle-detailed-day-collapse-button {
                display: flex !important; /* or inline-flex, check original */
            }
            @media print {
                 .itinerary-planner-styles .toggle-detailed-day-collapse-button {
                    display: none !important;
                 }
            }


            body, .container, .quote-group-section {
                box-shadow: none !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }
            .quote-group-section { padding-top: 1rem !important; }

            /* Styles from example file for .saved-html-view (and print) */
            .saved-html-view .day-section, @media print .day-section {
                margin-bottom: 16px;
                border: 1px solid #E0E0E0;
                border-radius: 0.375rem;
                background-color: #ffffff;
                box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
                page-break-inside: avoid;
            }
            .saved-html-view .day-header-container, @media print .day-header-container {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 8px;
                border-bottom: 1px solid #EEE;
                background-color: #fdfdfd !important; /* Ensure override */
                border-radius: 6px 6px 0 0;
                cursor: pointer !important; /* Keep clickable for saved HTML */
            }
             @media print .day-header-container { cursor: default !important; }

            .saved-html-view .day-header-title, @media print .day-header-title {
                font-size: 18px;
                font-weight: 600;
            }
            .saved-html-view .day-content-wrapper { /* Managed by JS toggle */
                padding: 0 8px 8px 8px;
            }
            .saved-html-view .activity-card, .saved-html-view .readonly-activity-card,
            @media print .activity-card, @media print .readonly-activity-card {
                background-color: white;
                border-radius: 8px;
                border: 1px solid #E0E0E0;
                padding: 16px;
                margin-bottom: 16px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                display: flex !important; /* Ensure it's flex */
                page-break-inside: avoid;
            }
            .saved-html-view .card-time-icon-area, @media print .card-time-icon-area { width: 100px; }
            .saved-html-view .card-icon, @media print .card-icon { font-size: 24px; }
            .saved-html-view .card-time, @media print .card-time { font-size: 14px; }
            .saved-html-view .card-image, @media print .card-image {
                width: 100px !important; /* Match example */
                height: 100px !important; /* Match example */
                object-fit: cover !important;
                margin-top: 8px;
            }
            .saved-html-view .card-location a, @media print .card-location a { text-decoration: none; color: #007bff; }
            @media print .card-location a { color: black; }
            @media print .card-location a::after { content: " (" attr(href) ")"; font-size: 7pt; }


            /* Day toggle button specific for saved-html-view (from example) */
            .saved-html-view .day-header-controls .day-toggle-button-static {
                display: inline-flex !important; /* Ensure visible in saved view */
                padding: 0.25rem; /* p-1 */
                border-radius: 0.25rem; /* rounded */
            }
            .saved-html-view .day-toggle-button-static svg {
                width: 1.25rem; /* w-5 */
                height: 1.25rem; /* h-5 */
                color: #4B5563; /* text-gray-600 */
            }
            .saved-html-view .readonly-collapse-button { display: inline-block !important; }


            @page {
                size: A4 portrait;
                margin: 15mm;
                @top-left { content: attr(data-document-title); font-size: 9pt; color: #555; }
                @top-right { content: "Page " counter(page) " / " counter(pages); font-size: 9pt; color: #555; }
                @bottom-left { content: "ÏÉùÏÑ±Ïùº: " attr(data-creation-date); font-size: 9pt; color: #555; }
                @bottom-right { content: "ÎÇ¥ÏùºÌà¨Ïñ¥ Í≤¨Ï†Å"; font-size: 9pt; color: #555; }
            }
            body::before { display: none; content: attr(data-document-title) attr(data-creation-date); }
        }
        @media print {
             .itinerary-planner-styles .card-image, .saved-html-view .card-image { display: none !important; } /* Hide images for print to save ink/space */
             .readonly-collapse-button { display: none !important; }
             .saved-html-view .day-header-controls .day-toggle-button-static { display: none !important; }
        }
    </style>
</head>
<body class="bg-white p-4">
    <div class="container mx-auto bg-white p-6 shadow-lg rounded-lg" style="max-width: 950px;">
        <header class="mb-6 border-b pb-4 border-gray-200">
            <h1 class="text-3xl font-bold text-center custom-orange">ÎÇ¥ÏùºÌà¨Ïñ¥ Ïó¨ÌñâÍ≤¨Ï†ÅÏÑú</h1>
        </header>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">Í∏∞Î≥∏ Ï†ïÎ≥¥</h2>
            <div class="bg-gray-50 p-4 rounded">
                <div class="flex flex-wrap gap-4">
                    <div class="w-full sm:w-2/10 mb-4 sm:mb-0">
                        <label class="block text-gray-700 mb-1 text-sm">Í≥†Í∞ùÎ™Ö(Î∞õÎäîÏù¥)</label>
                        <input type="text" id="customerName" name="custname" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                    <div class="w-full sm:w-4/10 mb-4 sm:mb-0">
                        <label class="block text-gray-700 mb-1 text-sm">Ïù¥Î©îÏùº</label>
                        <input type="email" id="customerEmail" name="custmail" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                    <div class="w-full sm:w-3/10">
                        <label class="block text-gray-700 mb-1 text-sm">Ï∞∏Ï°∞</label>
                        <input type="text" id="custcmail" name="custcmail" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                    </div>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-1 text-sm">Î©îÏùºÏ†úÎ™©</label>
                    <input type="text" id="subject" name="subject" value="[ÎÇ¥ÏùºÌà¨Ïñ¥]  Í≥†Í∞ùÎãò, ÌñâÎ≥µÌïú Ïó¨ÌñâÏùÑ ÏúÑÌïú Í≤¨Ï†Å ÏïàÎÇ¥ Î©îÏùºÏûÖÎãàÎã§." class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-2 text-sm">ÏïàÎÇ¥ÏÇ¨Ìï≠ (Î≥∏Î¨∏ Ï≤´ Î∂ÄÎ∂Ñ)</label>
                    <textarea id="introText" name="intro" rows="4" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="ÏïàÎÖïÌïòÏÑ∏Ïöî! ÎÇ¥ÏùºÌà¨Ïñ¥ÏûÖÎãàÎã§. Í≥†Í∞ùÎãòÏùò ÏÜåÏ§ëÌïú Ïó¨ÌñâÏùÑ Ìï®Íªò Ï§ÄÎπÑÌïòÍ≤†ÏäµÎãàÎã§."></textarea>
                </div>
                <div class="mt-4">
                    <label class="block text-gray-700 mb-1 text-sm">ÏÉÅÌíàÎ™Ö (Í≥µÌÜµ)</label>
                    <input type="text" id="goodnm" name="goodnm" value="" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm">
                </div>
            </div>
        </section>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">ÏòàÏïΩÏûê Ï†ïÎ≥¥</h2>
            <div class="bg-gray-50 p-4 rounded">
                <textarea id="travelerInfoText" name="traveler_info_text" rows="3" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="Ïòà : 1 HAN/WONHEE MR 2. LEE/SONGYI MS"></textarea>
            </div>
        </section>

        <div id="quoteGroupsContainer" class="mb-8">
            </div>

        <div class="text-center mb-8 py-4 border-t border-b border-gray-200">
            <button type="button" id="addGlobalQuoteGroupBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-md shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 text-sm">
                <i class="fas fa-plus mr-2"></i>ÏÉà Í≤¨Ï†Å Í∑∏Î£π Ï∂îÍ∞Ä
            </button>
        </div>

        <section class="mb-8">
            <h2 class="text-xl font-semibold mb-4 p-2 rounded" style="background-color: #e0f2f7; color: #000;">Îã¥ÎãπÏûê Ï†ïÎ≥¥</h2>
            <div class="bg-gray-50 p-4 rounded">
                <div class="flex flex-wrap gap-4">
                    <div class="w-full sm:w-2/10 mb-4 sm:mb-0"><label class="block text-gray-700 mb-1 text-sm">Îã¥ÎãπÏûê</label><input type="text" id="empnm" name="empnm" value="ÏûÑÏ∞ΩÏàú" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                    <div class="w-full sm:w-4/10 mb-4 sm:mb-0"><label class="block text-gray-700 mb-1 text-sm">Îã¥ÎãπÏûêÎ©îÏùº</label><input type="email" id="empmail" name="empmail" value="fire@naeiltour.co.kr" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                    <div class="w-full sm:w-3/10"><label class="block text-gray-700 mb-1 text-sm">Ïó∞ÎùΩÏ≤ò</label><input type="text" id="emptel" name="emptel" value="02-6262-5301" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm"></div>
                </div>
            </div>
        </section>

        <footer class="mt-8 text-center text-gray-500 text-sm border-t pt-4">
            <button type="button" onclick="previewQuote();" style="padding: 5px 10px;font-size: 13px;cursor: pointer;border: 1px solid #ccc;background: #e1e1e1;font-weight: 700;color: #000;">ÎØ∏Î¶¨Î≥¥Í∏∞</button>
            <button type="button" onclick="downloadGeneratedHTML(false);" style="padding: 5px 10px;font-size: 13px;cursor: pointer;border: 1px solid #ccc;background: #28a745;font-weight: 700;color: #fff; margin-left: 5px;">Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï® HTML Ï†ÄÏû•</button>
            <button type="button" onclick="downloadGeneratedHTML(true);" style="padding: 5px 10px;font-size: 13px;cursor: pointer;border: 1px solid #ccc;background: #17a2b8;font-weight: 700;color: #fff; margin-left: 5px;">ÎØ∏Î¶¨Î≥¥Í∏∞Ïö© HTML Ï†ÄÏû•</button>
            <input type="file" id="loadQuoteFile" accept=".html" style="display: none;">
            <button type="button" onclick="document.getElementById('loadQuoteFile').click();" style="padding: 5px 10px; font-size: 13px; cursor: pointer; border: 1px solid #ccc; background: #f0ad4e; font-weight: 700; color: #fff; margin-left: 5px;">Í≤¨Ï†Å Î∂àÎü¨Ïò§Í∏∞ (HTML)</button>
        </footer>
    </div>

    <div id="activityModal" class="modal-backdrop">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">ÏÉà ÏùºÏ†ï Ï∂îÍ∞Ä</h2>
            <form id="activityForm">
                <input type="hidden" id="currentQuoteGroupIndex">
                <input type="hidden" id="currentDayIndex">
                <input type="hidden" id="currentActivityId">
                <div>
                    <label for="activityTimeInput">ÏãúÍ∞Ñ (HHMM ÌòïÏãù, ÏÑ†ÌÉù ÏÇ¨Ìï≠):</label>
                    <input type="text" id="activityTimeInput" placeholder="Ïòà: 1130 ÎòêÎäî 0900" maxlength="4">
                </div>
                <div>
                    <label for="activityIconSelect">ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù:</label>
                    <select id="activityIconSelect"> </select>
                </div>
                <div>
                    <label for="activityTitle">ÌôúÎèô/Ïû•ÏÜåÎ™Ö:</label>
                    <input type="text" id="activityTitle" required placeholder="Ïòà: Î£®Î∏åÎ•¥ Î∞ïÎ¨ºÍ¥Ä Î∞©Î¨∏">
                </div>
                <div>
                    <label for="activityDescription">Í∞ÑÎã® ÏÑ§Î™Ö/Î©îÎ™®:</label>
                    <textarea id="activityDescription" rows="3" placeholder="Ïòà: Î™®ÎÇòÎ¶¨Ïûê Î∞è Ï£ºÏöî ÏûëÌíà Í¥ÄÎûå"></textarea>
                </div>
                <div>
                    <label for="activityLocation">Ï£ºÏÜå/ÏúÑÏπò ÎßÅÌÅ¨:</label>
                    <input type="url" id="activityLocation" placeholder="Ïòà: https://maps.google.com/... (ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <div>
                    <label for="activityImageUrl">Ïù¥ÎØ∏ÏßÄ URL:</label>
                    <input type="url" id="activityImageUrl" placeholder="Ïòà: https://example.com/image.jpg (ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <div>
                    <label for="activityCost">ÎπÑÏö©:</label>
                    <input type="text" id="activityCost" placeholder="Ïòà: ‚Ç¨20 ÎòêÎäî ‚Ç©25,000 (ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <div>
                    <label for="activityNotes">Í∏∞ÌÉÄ ÌïÑÎìú (ÏòàÏïΩÎ≤àÌò∏ Îì±):</label>
                    <input type="text" id="activityNotes" placeholder="Ïòà: ÏòàÏïΩÎ≤àÌò∏: 12345 (ÏÑ†ÌÉù ÏÇ¨Ìï≠)">
                </div>
                <div class="modal-buttons">
                    <button type="button" id="cancelActivityModalButton" class="action-button-sm bg-gray-300 hover:bg-gray-400 text-gray-800">Ï∑®ÏÜå</button>
                    <button type="submit" id="saveActivityModalButton" class="action-button-sm bg-green-500 text-white hover:bg-green-600">Ï†ÄÏû•</button>
                </div>
            </form>
        </div>
    </div>
    <div id="toast"></div>

    <input type="file" id="detailedItineraryHtmlLoadInput_main" accept=".html" style="display: none;">
    <input type="file" id="detailedItineraryExcelLoadInput_main" accept=".xlsx, .csv" style="display: none;">
    <input type="file" id="detailedDayHtmlLoadInput_main" accept=".html" style="display: none;">

    <script>
        // ----- Ï†ÑÏó≠ Î≥ÄÏàò Î∞è Ï¥àÍ∏∞Ìôî Ìï®Ïàò -----
        let quoteGroupCounter = 0;
        let quoteGroupDataStore = {};

        const travelEmojis = [
            { value: "", display: "ÏïÑÏù¥ÏΩò ÏóÜÏùå" }, { value: "‚úàÔ∏è", display: "‚úàÔ∏è Ìï≠Í≥µ" }, { value: "üè®", display: "üè® ÏàôÏÜå" }, { value: "üçΩÔ∏è", display: "üçΩÔ∏è ÏãùÏÇ¨" }, { value: "üèõÔ∏è", display: "üèõÔ∏è Í¥ÄÍ¥ë(Ïã§ÎÇ¥)" }, { value: "üèûÔ∏è", display: "üèûÔ∏è Í¥ÄÍ¥ë(ÏïºÏô∏)" }, { value: "üö∂", display: "üö∂ Ïù¥Îèô(ÎèÑÎ≥¥)" }, { value: "üöå", display: "üöå Ïù¥Îèô(Î≤ÑÏä§)" }, { value: "üöÜ", display: "üöÜ Ïù¥Îèô(Í∏∞Ï∞®)" }, { value: "üö¢", display: "üö¢ Ïù¥Îèô(Î∞∞)" }, { value: "üöï", display: "üöï Ïù¥Îèô(ÌÉùÏãú)" }, { value: "üõçÔ∏è", display: "üõçÔ∏è ÏáºÌïë" }, { value: "üì∑", display: "üì∑ ÏÇ¨ÏßÑÏ¥¨ÏòÅ" }, { value: "üó∫Ô∏è", display: "üó∫Ô∏è Í≥ÑÌöç/ÏßÄÎèÑ" }, { value: "üìå", display: "üìå Ï§ëÏöîÏû•ÏÜå" }, { value: "‚òï", display: "‚òï Ïπ¥Ìéò/Ìú¥Ïãù" }, { value: "üé≠", display: "üé≠ Í≥µÏó∞/Î¨∏Ìôî" }, { value: "üíº", display: "üíº ÏóÖÎ¨¥" }, { value: "‚ÑπÔ∏è", display: "‚ÑπÔ∏è Ï†ïÎ≥¥" }
        ];

        let currentGroupIndexForLoad = null;
        let currentDayIndexForLoad = null;

        // ----- Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò -----
        function generateId() { return 'id_' + Math.random().toString(36).substr(2, 9); }
        function formatDateForDisplay(dateString, dayNumber) {
            try {
                if (!isValidYyyyMmDd(String(dateString))) {
                    console.warn(`[formatDateForDisplay] Invalid YYYY-MM-DD format for DAY ${dayNumber}: '${dateString}'`);
                    return `DAY ${dayNumber}: ÎÇ†Ïßú ÌòïÏãù Ïò§Î•ò (Í∞í: ${dateString})`;
                }
                const parts = String(dateString).split('-');
                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1;
                const day = parseInt(parts[2], 10);
                const date = new Date(year, month, day);
                if (isNaN(date.getTime()) || date.getFullYear() !== year || date.getMonth() !== month || date.getDate() !== day) {
                    console.warn(`[formatDateForDisplay] Date object construction failed for DAY ${dayNumber}. Input: '${dateString}'`);
                    return `DAY ${dayNumber}: ÎÇ†Ïßú Î≥ÄÌôò Ïò§Î•ò (Í∞í: ${dateString})`;
                }
                const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                return `DAY ${dayNumber}: ${date.toLocaleDateString('ko-KR', options)}`;
            } catch (e) {
                console.error(`[formatDateForDisplay] Error for DAY ${dayNumber}, dateString: '${dateString}'`, e);
                return `DAY ${dayNumber}: ÎÇ†Ïßú Ï≤òÎ¶¨ ÏòàÏô∏`;
            }
        }
        function formatTimeToHHMM(timeStr) {
            if (timeStr && timeStr.length === 4 && /^\d{4}$/.test(timeStr)) {
                const hours = timeStr.substring(0, 2);
                const minutes = timeStr.substring(2, 4);
                if (parseInt(hours, 10) >= 0 && parseInt(hours, 10) <= 23 &&
                    parseInt(minutes, 10) >= 0 && parseInt(minutes, 10) <= 59) {
                    return `${hours}:${minutes}`;
                }
            }
            return "";
        }
        function dateToYyyyMmDd(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let dayVal = '' + d.getDate();
            const year = d.getFullYear();
            if (month.length < 2) month = '0' + month;
            if (dayVal.length < 2) dayVal = '0' + dayVal;
            return [year, month, dayVal].join('-');
        }
        function showToast(message, duration = 3000, isError = false) {
            const toastElement = document.getElementById('toast');
            if (toastElement) {
                toastElement.textContent = message;
                toastElement.style.backgroundColor = isError ? '#dc3545' : '#333';
                toastElement.classList.add('show');
                setTimeout(() => {
                    toastElement.classList.remove('show');
                }, duration);
            }
        }

        const quoteGroupBorderColors = ['#4A90E2', '#50E3C2', '#F5A623', '#BD10E0', '#7ED321', '#D0021B', '#417505', '#9013FE'];
        let currentBorderColorIndex = 0;

        function createQuoteGroup(groupIndex, afterElement = null, sourceGroupData = null) {
            const groupId = `quoteGroup_${groupIndex}`;
            const quoteGroupDiv = document.createElement('div');
            quoteGroupDiv.className = 'quote-group-section';
            quoteGroupDiv.id = groupId;
            quoteGroupDiv.dataset.groupIndex = groupIndex;

            let borderColorToApply = sourceGroupData?.borderColor || quoteGroupBorderColors[currentBorderColorIndex];
            quoteGroupDiv.style.borderColor = borderColorToApply;
            if (!sourceGroupData?.borderColor) {
                 currentBorderColorIndex = (currentBorderColorIndex + 1) % quoteGroupBorderColors.length;
            }

            quoteGroupDataStore[groupIndex] = sourceGroupData || {
                groupTitle: "",
                borderColor: borderColorToApply,
                priceSubgroups: [],
                inclusionExclusion: { includedTextarea: '', excludedTextarea: '' },
                flightSubgroups: [],
                itinerarySummaryRows: [],
                detailedItinerary: { title: "Ïó¨Ìñâ ÏùºÏ†ïÌëú", days: [] }
            };
             if (sourceGroupData && !quoteGroupDataStore[groupIndex].detailedItinerary) {
                quoteGroupDataStore[groupIndex].detailedItinerary = { title: "Ïó¨Ìñâ ÏùºÏ†ïÌëú", days: [] };
            }
             if (sourceGroupData && typeof quoteGroupDataStore[groupIndex].detailedItinerary.title === 'undefined') {
                quoteGroupDataStore[groupIndex].detailedItinerary.title = "Ïó¨Ìñâ ÏùºÏ†ïÌëú";
            }
             if (sourceGroupData && !sourceGroupData.flightSubgroups) {
                quoteGroupDataStore[groupIndex].flightSubgroups = [];
            }
             if (sourceGroupData && !sourceGroupData.priceSubgroups) {
                quoteGroupDataStore[groupIndex].priceSubgroups = [];
            }
            if (sourceGroupData && !sourceGroupData.itinerarySummaryRows) {
                quoteGroupDataStore[groupIndex].itinerarySummaryRows = [];
            }

            quoteGroupDiv.innerHTML = `
                <div class="group-action-buttons">
                    <button type="button" class="copy-quote-group-btn" title="Ïù¥ Í≤¨Ï†Å Í∑∏Î£π Î≥µÏÇ¨"><i class="fas fa-copy mr-1"></i>Í∑∏Î£π Î≥µÏÇ¨</button>
                    <button type="button" class="delete-quote-group-btn" title="Ïù¥ Í≤¨Ï†Å Í∑∏Î£π ÏÇ≠Ï†ú"><i class="fas fa-trash-alt mr-1"></i>Í∑∏Î£π ÏÇ≠Ï†ú</button>
                </div>
                <input type="text" name="quote_group_title[${groupIndex}]" class="group-title-input" placeholder="Í≤¨Ï†Å Í∑∏Î£π Ï†úÎ™© (Ïòà: 1. ÎåÄÌïúÌï≠Í≥µ + Ïã†Îùº Î™®ÎÖ∏Í∑∏Îû® Îã§ÎÇ≠ ÏäàÌéòÎ¶¨Ïñ¥)" value="${quoteGroupDataStore[groupIndex].groupTitle}">

                <section class="mb-8 price-section-wrapper">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold bg-custom-orange p-2 rounded" style="flex-grow: 1;">ÏöîÍ∏à ÏïàÎÇ¥</h3>
                        <button type="button" class="add-price-subgroup-button bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-xs ml-2" data-group-index="${groupIndex}">
                            <i class="fas fa-plus mr-1"></i> ÏöîÍ∏à ÏÜåÍ∑∏Î£π Ï∂îÍ∞Ä
                        </button>
                    </div>
                    <div id="priceSectionsContainer_${groupIndex}" class="price-sections-container-for-group"></div>
                </section>

                <section class="mb-8 inclusion-exclusion-section-wrapper">
                    <h3 class="text-lg font-semibold mb-4 bg-custom-orange p-2 rounded">Ìè¨Ìï®/Î∂àÌè¨Ìï® ÏÇ¨Ìï≠</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="text-md font-medium mb-2">Ìè¨Ìï®</h4>
                            <textarea name="included_items_textarea[${groupIndex}]" rows="5" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="* Ïú†Î•òÌï†Ï¶ùÎ£å, Ï†úÏÑ∏Í≥µÍ≥ºÍ∏à Ìè¨Ìï®...">${quoteGroupDataStore[groupIndex].inclusionExclusion.includedTextarea}</textarea>
                        </div>
                        <div class="bg-gray-50 p-4 rounded">
                            <h4 class="text-md font-medium mb-2">Î∂àÌè¨Ìï®</h4>
                            <textarea name="excluded_items_textarea[${groupIndex}]" rows="5" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm" placeholder="‚óè ÌòÑÏßÄ Í∞úÏù∏ Í≤ΩÎπÑ...">${quoteGroupDataStore[groupIndex].inclusionExclusion.excludedTextarea}</textarea>
                        </div>
                    </div>
                </section>

                <section class="mb-8 flight-schedule-section-wrapper">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold bg-custom-orange p-2 rounded" style="flex-grow: 1;">Ìï≠Í≥µ Ïä§ÏºÄÏ§Ñ</h3>
                        <button type="button" class="add-flight-subgroup-button bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 transition text-xs ml-2" data-group-index="${groupIndex}">
                            <i class="fas fa-plus mr-1"></i> Ìï≠Í≥µ Ïä§ÏºÄÏ§Ñ ÏÜåÍ∑∏Î£π Ï∂îÍ∞Ä
                        </button>
                    </div>
                    <div id="flightScheduleGroupsContainer_${groupIndex}" class="flight-schedule-groups-container-for-group"></div>
                </section>

                <section class="mb-8 itinerary-summary-section-wrapper">
                    <h3 class="text-lg font-semibold mb-4 bg-custom-orange p-2 rounded">Í∞ÑÎã®ÏùºÏ†ï</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border text-sm">
                            <thead><tr class="bg-gray-100">
                                <th class="border p-2 text-left text-xs" style="width: 8%;">ÏùºÏàò</th><th class="border p-2 text-left text-xs">ÎÇ†Ïßú</th>
                                <th class="border p-2 text-left text-xs">Ï∂úÎ∞úÏßÄ</th><th class="border p-2 text-left text-xs">ÎèÑÏ∞©ÏßÄ</th>
                                <th class="border p-2 text-left text-xs">ÏàôÎ∞ï</th><th class="border p-2 text-left text-xs">Ïù¥Îèô</th>
                                <th class="border p-2 text-left text-xs">ÎπÑÍ≥†</th><th class="border p-2 text-center w-12 text-xs">ÏÇ≠Ï†ú</th></tr></thead>
                            <tbody id="itineraryTableBody_${groupIndex}" class="itinerary-table-body-for-group"></tbody>
                            <tfoot><tr><td colspan="8" class="border p-2"><button type="button" class="add-itinerary-row-to-group bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs" data-group-index="${groupIndex}"><i class="fas fa-plus mr-1"></i> Ìñâ Ï∂îÍ∞Ä</button></td></tr></tfoot>
                        </table>
                    </div>
                </section>

                <section class="mb-8 itinerary-detail-section-wrapper">
                    <div class="flex justify-between items-center mb-2 bg-custom-orange p-2 rounded-t-md">
                        <h3 class="text-lg font-semibold">ÏÉÅÌíàÏùºÏ†ï ÏÉÅÏÑ∏ (ÏùºÏ†ïÌëú)</h3>
                        <div class="itinerary-planner-styles flex items-center space-x-1">
                             <button type="button" class="action-button-sm save-detailed-itinerary-html-btn" style="background-color: #fdba74;" title="Ïù¥ Í∑∏Î£π ÏùºÏ†ï HTMLÎ°ú Ï†ÄÏû•" data-group-index="${groupIndex}"><i class="fas fa-file-code"></i><span class="hidden sm:inline">ÏùºÏ†ï HTML Ï†ÄÏû•</span></button>
                             <button type="button" class="action-button-sm load-detailed-itinerary-html-btn" style="background-color: #FACC15;" title="HTML ÌååÏùºÏóêÏÑú Ïù¥ Í∑∏Î£π ÏùºÏ†ï Î∂àÎü¨Ïò§Í∏∞" data-group-index="${groupIndex}"><i class="fas fa-upload"></i><span class="hidden sm:inline">HTML Î∂àÎü¨Ïò§Í∏∞</span></button>
                             <button type="button" class="action-button-sm load-detailed-itinerary-excel-btn" style="background-color: #22C55E;" title="ÏóëÏÖÄ ÌååÏùºÏóêÏÑú Ïù¥ Í∑∏Î£π ÏùºÏ†ï Î∂àÎü¨Ïò§Í∏∞" data-group-index="${groupIndex}"><i class="fas fa-file-excel"></i><span class="hidden sm:inline">ÏóëÏÖÄ Î∂àÎü¨Ïò§Í∏∞</span></button>
                        </div>
                    </div>
                    <div id="detailedItineraryContainer_${groupIndex}" class="itinerary-planner-styles p-4 border border-t-0 border-gray-200 rounded-b-md bg-gray-100" style="min-height: 150px;">
                        <input type="text" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-sm mb-2" name="detailed_itinerary_title[${groupIndex}]" placeholder="ÏÉÅÏÑ∏ ÏùºÏ†ïÌëú Ï†úÎ™© (Ïòà: Ï¶êÍ±∞Ïö¥ Îã§ÎÇ≠ 3Î∞ï 5Ïùº)" value="${quoteGroupDataStore[groupIndex].detailedItinerary.title || 'Ïó¨Ìñâ ÏùºÏ†ïÌëú'}">
                        <div id="daysContainerStatic_${groupIndex}"></div>
                        <div class="add-day-button-container mt-4 text-center">
                             <button type="button" class="add-detailed-itinerary-day-button action-button-sm bg-indigo-500 text-white hover:bg-indigo-600" data-group-index="${groupIndex}">
                                <i class="fas fa-plus"></i> ÏÉà ÎÇ†Ïßú Ï∂îÍ∞Ä
                            </button>
                        </div>
                    </div>
                </section>
            `;

            const quoteGroupsContainer = document.getElementById('quoteGroupsContainer');
            if (afterElement && afterElement.parentNode === quoteGroupsContainer) {
                quoteGroupsContainer.insertBefore(quoteGroupDiv, afterElement.nextSibling);
            } else {
                quoteGroupsContainer.appendChild(quoteGroupDiv);
            }

            initPriceSectionForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].priceSubgroups);
            initFlightScheduleForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].flightSubgroups);
            initInclusionExclusionForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex]);
            initItinerarySummaryForGroup(quoteGroupDiv, groupIndex, quoteGroupDataStore[groupIndex].itinerarySummaryRows);
            renderDetailedItineraryForGroup(groupIndex);

            return quoteGroupDiv;
        }

        function renderDetailedItineraryForGroup(groupIndex) {
            const groupData = quoteGroupDataStore[groupIndex];
            if (!groupData) { console.error(`Group data not found for groupIndex: ${groupIndex}`); return; }
            if (!groupData.detailedItinerary) { groupData.detailedItinerary = { title: "Ïó¨Ìñâ ÏùºÏ†ïÌëú", days: [] }; console.log(`Initialized missing detailedItinerary for group ${groupIndex}`); }
            if (!Array.isArray(groupData.detailedItinerary.days)) { groupData.detailedItinerary.days = []; console.log(`Initialized missing or invalid detailedItinerary.days to [] for group ${groupIndex}`);}

            const container = document.getElementById(`detailedItineraryContainer_${groupIndex}`);
            if (!container) { console.error(`Detailed itinerary container not found for group ${groupIndex}`); return; }

            let daysHost = container.querySelector(`#daysContainerStatic_${groupIndex}`);
            if (!daysHost) {
                daysHost = document.createElement('div'); daysHost.id = `daysContainerStatic_${groupIndex}`;
                const addDayButtonContainer = container.querySelector('.add-day-button-container');
                if (addDayButtonContainer) container.insertBefore(daysHost, addDayButtonContainer); else container.appendChild(daysHost);
            }
            daysHost.innerHTML = '';

            groupData.detailedItinerary.days.forEach((day, dayIdx) => {
                if (!day || typeof day.date === 'undefined') {
                    console.warn(`[Render Group ${groupIndex}] Day object at index ${dayIdx} is invalid. Skipping. Day data:`, day);
                    const tempDate = dateToYyyyMmDd(new Date());
                    const daySection = document.createElement('div'); daySection.className = 'day-section'; daySection.dataset.dayIndex = dayIdx;
                    daySection.innerHTML = `<div class="p-2 text-red-500">DAY ${dayIdx + 1}: ÎÇ†Ïßú Ï†ïÎ≥¥ Ïò§Î•ò (ÏûÑÏãú: ${formatDateForDisplay(tempDate, dayIdx+1)}) </div>`;
                    daysHost.appendChild(daySection); return;
                }

                const daySection = document.createElement('div'); daySection.className = 'day-section'; daySection.dataset.dayIndex = dayIdx;
                let dateDisplayHTML;
                if (day.editingDate) {
                    dateDisplayHTML = `
                        <input type="text" class="date-edit-input itinerary-planner-styles" value="${day.date}" placeholder="YYYY-MM-DD ÎòêÎäî YYYYMMDD">
                        <button class="icon-button save-detailed-date-button itinerary-planner-styles" data-group-index="${groupIndex}" data-day-index="${dayIdx}" title="ÎÇ†Ïßú Ï†ÄÏû•"><i class="fas fa-save"></i></button>
                        <button class="icon-button cancel-detailed-date-edit-button itinerary-planner-styles" data-group-index="${groupIndex}" data-day-index="${dayIdx}" title="Ï∑®ÏÜå"><i class="fas fa-times"></i></button>`;
                } else {
                    dateDisplayHTML = `
                        <h2 class="day-header-title">${formatDateForDisplay(day.date, dayIdx + 1)}</h2>
                        <button class="icon-button edit-detailed-date-button ml-2 itinerary-planner-styles" title="ÎÇ†Ïßú ÏàòÏ†ï" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-pencil-alt"></i></button>`;
                }

                daySection.innerHTML = `
                    <div class="day-header-container" style="cursor: grab;">
                        <div class="day-header-main">${dateDisplayHTML}</div>
                        <div class="day-header-controls">
                            <button class="icon-button save-detailed-day-html-btn itinerary-planner-styles" title="Ïù¥ ÎÇ†Ïßú HTMLÎ°ú Ï†ÄÏû•" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-file-alt"></i></button>
                            <button class="icon-button load-detailed-day-html-button itinerary-planner-styles" title="Ïù¥ ÎÇ†ÏßúÏóê HTML ÎçÆÏñ¥Ïì∞Í∏∞" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-clipboard"></i></button>
                            <button class="icon-button delete-detailed-day-button itinerary-planner-styles" title="Ïù¥ ÎÇ†Ïßú Ï†ÑÏ≤¥ ÏÇ≠Ï†ú" data-group-index="${groupIndex}" data-day-index="${dayIdx}"><i class="fas fa-trash-alt"></i></button>
                            <button class="icon-button toggle-detailed-day-collapse-button itinerary-planner-styles" title="ÌéºÏπòÍ∏∞/Ï†ëÍ∏∞" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                                <i class="fas ${day.isCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'}"></i></button>
                        </div>
                    </div>
                    <div class="day-content-wrapper ${day.isCollapsed ? 'hidden' : ''}">
                        <div class="activities-list activities-list-group-${groupIndex}-day-${dayIdx} pt-3" data-group-index="${groupIndex}" data-day-index="${dayIdx}" style="min-height: 20px;"></div>
                        <button class="add-activity-to-day-button mt-3 mb-2 action-button" data-group-index="${groupIndex}" data-day-index="${dayIdx}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Ïù¥ ÎÇ†ÏßúÏóê ÏÉà ÏùºÏ†ï Ï∂îÍ∞Ä
                        </button>
                    </div>`;
                daysHost.appendChild(daySection);
                renderDetailedActivitiesForDayInGroup(groupIndex, dayIdx);
            });

            if (daysHost && daysHost.children.length > 0) {
                if (daysHost.sortableInstance) daysHost.sortableInstance.destroy();
                daysHost.sortableInstance = new Sortable(daysHost, {
                    animation: 150, handle: '.day-header-container', ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
                    onEnd: function(evt) {
                        const oldIndex = evt.oldDraggableIndex; const newIndex = evt.newDraggableIndex;
                        if (oldIndex !== undefined && newIndex !== undefined && oldIndex !== newIndex) {
                            const movedDay = quoteGroupDataStore[groupIndex].detailedItinerary.days.splice(oldIndex, 1)[0];
                            quoteGroupDataStore[groupIndex].detailedItinerary.days.splice(newIndex, 0, movedDay);
                            recalculateAllDetailedDates(groupIndex, Math.min(oldIndex, newIndex));
                            renderDetailedItineraryForGroup(groupIndex);
                        }
                    }
                });
            }
        }

        function renderDetailedActivitiesForDayInGroup(groupIndex, dayIndex) {
            const groupData = quoteGroupDataStore[groupIndex];
            const day = groupData.detailedItinerary.days[dayIndex];
            const activitiesListContainer = document.querySelector(`.activities-list-group-${groupIndex}-day-${dayIndex}`);
            if (!day || !activitiesListContainer) { console.error(`Day data/container not found for group ${groupIndex}, day ${dayIndex}`); return; }
            activitiesListContainer.innerHTML = '';

            day.activities.forEach(activity => {
                const card = document.createElement('div'); card.className = 'activity-card'; card.dataset.activityId = activity.id; card.style.cursor = 'grab';
                let imageHTML = activity.imageUrl ? `<img src="${activity.imageUrl}" alt="${activity.title || 'ÌôúÎèô Ïù¥ÎØ∏ÏßÄ'}" class="card-image" onerror="this.style.display='none';">` : '';
                card.innerHTML = `
                    <div class="card-time-icon-area">
                        <div class="card-icon">${activity.icon || ''}</div><div class="card-time">${formatTimeToHHMM(activity.time)}</div></div>
                    <div class="card-details-area">
                        <div class="card-title">${activity.title || ''}</div>
                        ${activity.description ? `<div class="card-description">${activity.description}</div>` : ''}
                        ${imageHTML}
                        ${activity.locationLink ? `<div class="card-location">üìç <a href="${activity.locationLink}" target="_blank" rel="noopener noreferrer">ÏúÑÏπò Î≥¥Í∏∞</a></div>` : ''}
                        ${activity.cost ? `<div class="card-cost">üí∞ ${activity.cost}</div>` : ''}
                        ${activity.notes ? `<div class="card-notes">üìù ${activity.notes}</div>` : ''}</div>
                    <div class="card-actions-direct">
                        <button class="icon-button edit-activity-button itinerary-planner-styles" title="ÏàòÏ†ï" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="icon-button duplicate-activity-button itinerary-planner-styles" title="Î≥µÏ†ú" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-copy"></i></button>
                        <button class="icon-button delete-activity-button itinerary-planner-styles" title="ÏÇ≠Ï†ú" data-group-index="${groupIndex}" data-day-index="${dayIndex}" data-activity-id="${activity.id}"><i class="fas fa-trash-alt"></i></button></div>`;
                activitiesListContainer.appendChild(card);
            });

            if (activitiesListContainer && activitiesListContainer.children.length >= 0) {
                 if (activitiesListContainer.sortableInstance) activitiesListContainer.sortableInstance.destroy();
                activitiesListContainer.sortableInstance = new Sortable(activitiesListContainer, {
                    group: `shared-activities-group-${groupIndex}`, animation: 150, handle: '.activity-card', ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen',
                    onEnd: function(evt) {
                        const fromDayIndex = parseInt(evt.from.dataset.dayIndex); const toDayIndex = parseInt(evt.to.dataset.dayIndex);
                        const oldActivityIndex = evt.oldDraggableIndex; const newActivityIndex = evt.newDraggableIndex;
                        if (oldActivityIndex !== undefined && newActivityIndex !== undefined) {
                            const movedActivity = quoteGroupDataStore[groupIndex].detailedItinerary.days[fromDayIndex].activities.splice(oldActivityIndex, 1)[0];
                            quoteGroupDataStore[groupIndex].detailedItinerary.days[toDayIndex].activities.splice(newActivityIndex, 0, movedActivity);
                            renderDetailedItineraryForGroup(groupIndex);
                        }
                    }
                });
            }
        }

        function handleAddDetailedItineraryDay(groupIndex) {
            const groupData = quoteGroupDataStore[groupIndex];
            if (!groupData || !groupData.detailedItinerary) { console.error(`Cannot add day: detailedItinerary data is missing for group ${groupIndex}`); return; }
            let newDate; const daysArray = groupData.detailedItinerary.days;
            if (daysArray.length > 0) {
                const lastDayObject = daysArray[daysArray.length - 1];
                if (lastDayObject && lastDayObject.date && isValidYyyyMmDd(lastDayObject.date)) {
                    const lastDateStr = lastDayObject.date; const parts = lastDateStr.split('-');
                    const year = parseInt(parts[0], 10); const monthVal = parseInt(parts[1], 10) - 1; const dayVal = parseInt(parts[2], 10);
                    const lastDate = new Date(year, monthVal, dayVal);
                    if (isNaN(lastDate.getTime())) { console.warn(`[handleAddDetailedItineraryDay] lastDate parsed as invalid. Defaulting to today.`); newDate = new Date(); }
                    else { newDate = new Date(lastDate); newDate.setDate(lastDate.getDate() + 1); }
                } else { console.warn(`[handleAddDetailedItineraryDay] Last day's date invalid. Defaulting to today.`); newDate = new Date(); }
            } else { newDate = new Date(); }
            let newDayDateString = dateToYyyyMmDd(newDate);
            if (newDayDateString === "NaN-NaN-NaN") { console.error(`[handleAddDetailedItineraryDay] CRITICAL: newDayDateString is 'NaN-NaN-NaN'. Forcing to today.`); newDayDateString = dateToYyyyMmDd(new Date());}
            daysArray.push({ date: newDayDateString, activities: [], isCollapsed: false, editingDate: false });
            renderDetailedItineraryForGroup(groupIndex);
        }

        const activityModal = document.getElementById('activityModal');
        const activityForm = document.getElementById('activityForm');
        const modalTitle = document.getElementById('modalTitle');
        const activityIconSelect = document.getElementById('activityIconSelect');
        const currentQuoteGroupIndexInput = document.getElementById('currentQuoteGroupIndex');
        const currentDayIndexInput = document.getElementById('currentDayIndex');
        const currentActivityIdInput = document.getElementById('currentActivityId');

        function populateIconDropdown() { activityIconSelect.innerHTML = ''; travelEmojis.forEach(emoji => { const option = document.createElement('option'); option.value = emoji.value; option.textContent = emoji.display; activityIconSelect.appendChild(option); });}
        function openActivityModal(groupIndex, dayIndex, activityId = null) {
            currentQuoteGroupIndexInput.value = groupIndex; currentDayIndexInput.value = dayIndex; activityForm.reset(); populateIconDropdown();
            if (activityId) {
                modalTitle.textContent = 'ÏùºÏ†ï ÏàòÏ†ï'; currentActivityIdInput.value = activityId;
                const activity = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities.find(act => act.id === activityId);
                if (activity) {
                    document.getElementById('activityTimeInput').value = activity.time || ""; activityIconSelect.value = activity.icon || "";
                    document.getElementById('activityTitle').value = activity.title || ""; document.getElementById('activityDescription').value = activity.description || "";
                    document.getElementById('activityLocation').value = activity.locationLink || ""; document.getElementById('activityImageUrl').value = activity.imageUrl || "";
                    document.getElementById('activityCost').value = activity.cost || ""; document.getElementById('activityNotes').value = activity.notes || "";
                }
            } else { modalTitle.textContent = 'ÏÉà ÏùºÏ†ï Ï∂îÍ∞Ä'; currentActivityIdInput.value = ''; activityIconSelect.value = travelEmojis[0].value; }
            activityModal.style.display = 'flex';
        }
        function closeActivityModal() { activityModal.style.display = 'none';}
        document.getElementById('cancelActivityModalButton').addEventListener('click', closeActivityModal);
        activityForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const groupIndex = currentQuoteGroupIndexInput.value; const dayIndex = parseInt(currentDayIndexInput.value); const activityId = currentActivityIdInput.value;
            const timeValue = document.getElementById('activityTimeInput').value.trim();
            if (timeValue && (timeValue.length !== 4 || !/^\d{4}$/.test(timeValue))) { showToast("ÏãúÍ∞ÑÏùÄ HHMM ÌòïÏãùÏùò 4ÏûêÎ¶¨ Ïà´ÏûêÎ°ú ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÎπÑÏõåÎëêÏÑ∏Ïöî.", 3000, true); return; }
            if (timeValue.length === 4) { const hours = parseInt(timeValue.substring(0, 2), 10); const minutes = parseInt(timeValue.substring(2, 4), 10); if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59) { showToast("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏãúÍ∞ÑÏûÖÎãàÎã§.", 3000, true); return; }}
            const activityData = { id: activityId || generateId(), time: timeValue, icon: activityIconSelect.value, title: document.getElementById('activityTitle').value, description: document.getElementById('activityDescription').value, locationLink: document.getElementById('activityLocation').value, imageUrl: document.getElementById('activityImageUrl').value, cost: document.getElementById('activityCost').value, notes: document.getElementById('activityNotes').value };
            const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities;
            if (activityId) { const activityIndex = dayActivities.findIndex(act => act.id === activityId); if (activityIndex > -1) dayActivities[activityIndex] = activityData; }
            else { dayActivities.push(activityData); }
            renderDetailedItineraryForGroup(groupIndex); closeActivityModal();
        });

        function isValidYyyyMmDd(dateString) {
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return false;
            const parts = dateString.split("-"); const year = parseInt(parts[0], 10); const month = parseInt(parts[1], 10); const day = parseInt(parts[2], 10);
            if (year < 1000 || year > 3000 || month === 0 || month > 12) return false;
            const testDate = new Date(year, month - 1, day);
            return (testDate.getFullYear() === year && testDate.getMonth() === month - 1 && testDate.getDate() === day);
        }
        function parseAndFormatDateInput(inputValue) {
            let dateStr = String(inputValue).trim().replace(/\./g, '-');
            if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) { const parts = dateStr.split('-'); const year = parts[0]; const month = parts[1].padStart(2,'0'); const day = parts[2].padStart(2,'0'); const formatted = `${year}-${month}-${day}`; if (isValidYyyyMmDd(formatted)) return formatted; }
            if (/^\d{8}$/.test(dateStr)) { const year = dateStr.substring(0, 4); const month = dateStr.substring(4, 6); const day = dateStr.substring(6, 8); const formatted = `${year}-${month}-${day}`; if (isValidYyyyMmDd(formatted)) return formatted; }
            if (/^\d{6}$/.test(dateStr)) { const year = `20${dateStr.substring(0, 2)}`; const month = dateStr.substring(2, 4); const day = dateStr.substring(4, 6); const formatted = `${year}-${month}-${day}`; if (isValidYyyyMmDd(formatted)) return formatted; }
            return null;
        }
        function recalculateAllDetailedDates(groupIndex, startingDayIndex) {
            const daysArray = quoteGroupDataStore[groupIndex].detailedItinerary.days;
            if (daysArray.length > startingDayIndex && daysArray[startingDayIndex]) {
                const startDateString = daysArray[startingDayIndex].date;
                if (!startDateString || !isValidYyyyMmDd(startDateString)) { console.warn(`[recalculateAllDetailedDates] Invalid start date at index ${startingDayIndex}: '${startDateString}'. Aborting.`); return; }
                const parts = startDateString.split('-'); const year = parseInt(parts[0], 10); const month = parseInt(parts[1], 10) - 1; const day = parseInt(parts[2], 10);
                let currentDate = new Date(year, month, day);
                if (isNaN(currentDate.getTime())) { console.error(`[recalculateAllDetailedDates] Failed to create Date from '${startDateString}'. Aborting.`); return;}
                for (let i = startingDayIndex + 1; i < daysArray.length; i++) { if (daysArray[i]) { currentDate.setDate(currentDate.getDate() + 1); daysArray[i].date = dateToYyyyMmDd(currentDate);}}
            }
        }
        function handleEditDayDate(groupIndex, dayIndex) { quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = true; renderDetailedItineraryForGroup(groupIndex); const inputField = document.querySelector(`#detailedItineraryContainer_${groupIndex} .day-section[data-day-index="${dayIndex}"] .date-edit-input`); if (inputField) { inputField.focus(); inputField.select(); }}
        function handleSaveDayDate(groupIndex, dayIndex) {
            const inputField = document.querySelector(`#detailedItineraryContainer_${groupIndex} .day-section[data-day-index="${dayIndex}"] .date-edit-input`);
            if (inputField) {
                const validatedDate = parseAndFormatDateInput(inputField.value);
                if (validatedDate && isValidYyyyMmDd(validatedDate)) {
                    quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].date = validatedDate;
                    quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = false;
                    recalculateAllDetailedDates(groupIndex, dayIndex);
                    renderDetailedItineraryForGroup(groupIndex);
                } else { showToast("ÏûòÎ™ªÎêú ÎÇ†Ïßú ÌòïÏãùÏûÖÎãàÎã§. (YYYY-MM-DD ÎòêÎäî YYYYMMDD)", 3000, true); }
            }
        }
        function handleCancelEditDayDate(groupIndex, dayIndex) { quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].editingDate = false; renderDetailedItineraryForGroup(groupIndex);}
        function handleDeleteDetailedItineraryDay(groupIndex, dayIndex) {
            if (window.confirm(`DAY ${dayIndex + 1} ÏùºÏ†ïÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                quoteGroupDataStore[groupIndex].detailedItinerary.days.splice(dayIndex, 1);
                if (quoteGroupDataStore[groupIndex].detailedItinerary.days.length > 0) {
                     if (dayIndex === 0 && quoteGroupDataStore[groupIndex].detailedItinerary.days.length > 0 && isValidYyyyMmDd(quoteGroupDataStore[groupIndex].detailedItinerary.days[0].date)) { recalculateAllDetailedDates(groupIndex, 0); }
                     else if (dayIndex > 0 && isValidYyyyMmDd(quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex -1].date) ) { recalculateAllDetailedDates(groupIndex, dayIndex -1 ); }
                     else if (quoteGroupDataStore[groupIndex].detailedItinerary.days.length > 0 && isValidYyyyMmDd(quoteGroupDataStore[groupIndex].detailedItinerary.days[0].date)) { recalculateAllDetailedDates(groupIndex, 0); }
                }
                renderDetailedItineraryForGroup(groupIndex);
            }
        }
        function handleToggleDayCollapse(groupIndex, dayIndex) { const dayData = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex]; dayData.isCollapsed = !dayData.isCollapsed; renderDetailedItineraryForGroup(groupIndex); }
        function handleDuplicateActivity(groupIndex, dayIndex, activityId) {
            const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities;
            const activityToDuplicate = dayActivities.find(act => act.id === activityId);
            if (activityToDuplicate) { const newActivity = { ...activityToDuplicate, id: generateId(), title: `${activityToDuplicate.title} (Î≥µÏÇ¨Î≥∏)` }; const originalIndex = dayActivities.findIndex(act => act.id === activityId); dayActivities.splice(originalIndex + 1, 0, newActivity); renderDetailedItineraryForGroup(groupIndex); }
        }
        function handleDeleteActivity(groupIndex, dayIndex, activityId) { if (window.confirm("Ïù¥ ÌôúÎèôÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { const dayActivities = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities; quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndex].activities = dayActivities.filter(act => act.id !== activityId); renderDetailedItineraryForGroup(groupIndex);}}

        // --- HTML Generation and Saving ---
        function generateReadOnlyHTMLViewForQuoteGroup(groupIndex) {
            const groupData = quoteGroupDataStore[groupIndex]; if (!groupData || !groupData.detailedItinerary) return "";
            const itineraryData = groupData.detailedItinerary; let daysHTML = '';
            itineraryData.days.forEach((day, dayIdx) => {
                let activitiesHTML = '';
                day.activities.forEach(activity => {
                    let imageHTML = activity.imageUrl ? `<img src="${activity.imageUrl}" alt="${activity.title || 'ÌôúÎèô Ïù¥ÎØ∏ÏßÄ'}" class="card-image" onerror="this.style.display='none';">` : '';
                    activitiesHTML += `
                        <div class="readonly-activity-card">
                            <div class="card-time-icon-area">
                                ${activity.icon ? `<div class="card-icon">${activity.icon}</div>` : '<div class="card-icon" style="height: 28.8px;"></div>'}
                                <div class="card-time">${formatTimeToHHMM(activity.time)}</div></div>
                            <div class="card-details-area">
                                <div class="card-title">${activity.title || ''}</div>
                                ${activity.description ? `<div class="card-description">${activity.description}</div>` : ''} ${imageHTML}
                                ${activity.locationLink ? `<div class="card-location">üìç <a href="${activity.locationLink}" target="_blank" rel="noopener noreferrer">ÏúÑÏπò Î≥¥Í∏∞</a></div>` : ''}
                                ${activity.cost ? `<div class="card-cost">üí∞ ${activity.cost}</div>` : ''}
                                ${activity.notes ? `<div class="card-notes">üìù ${activity.notes}</div>` : ''}</div></div>`;});
                const dayHeaderId = `day-header-readonly-trip-${groupIndex}-${dayIdx}`;
                const isDayCollapsedForView = true; // Default to collapsed for preview/saved HTML

                const expandedIcon = '<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
                const collapsedIcon = '<svg class="toggle-icon w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>';
                daysHTML += `
                    <div class="day-section bg-white shadow-sm rounded-md">
                        <div class="day-header-container" id="${dayHeaderId}" onclick="toggleDayView(this)">
                            <div class="day-header-main"><h2 class="day-header-title">${formatDateForDisplay(day.date, dayIdx + 1)}</h2></div>
                            <div class="day-header-controls">
                                <span class="day-toggle-button-static p-1 rounded">
                                     ${isDayCollapsedForView ? collapsedIcon : expandedIcon}
                                </span>
                            </div>
                        </div>
                        <div class="day-content-wrapper ${isDayCollapsedForView ? 'hidden' : ''}">
                            <div class="activities-list pt-3">${activitiesHTML}</div>
                             <div class="text-right p-2 mt-2">
                                <button type="button" class="readonly-collapse-button" onclick="document.getElementById('${dayHeaderId}').click(); event.stopPropagation();">
                                    ÏùºÏ∞® Ï†ëÍ∏∞
                                </button>
                            </div>
                        </div>
                    </div>`;
            });
            return `<header class="readonly-view-header"><h1>${itineraryData.title || 'Ïó¨Ìñâ ÏùºÏ†ïÌëú'}</h1></header><main class="readonly-main-content saved-html-view"><div id="daysContainerReadOnly_${groupIndex}">${daysHTML}</div></main>`;
        }

        function handleSaveDetailedItineraryAsHtml(groupIndex) {
            const groupData = quoteGroupDataStore[groupIndex]; if (!groupData || !groupData.detailedItinerary) { showToast('Ï†ÄÏû•Ìï† ÏÉÅÏÑ∏ ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 3000, true); return; }
            const itineraryDataToSave = JSON.parse(JSON.stringify(groupData.detailedItinerary));
            itineraryDataToSave.days.forEach(day => day.isCollapsed = true); // Ensure data saved with collapsed state
            const itineraryDataString = JSON.stringify(itineraryDataToSave); const safeItineraryDataString = itineraryDataString.replace(/<\/script>/g, '<\\/script>');
            const readOnlyViewHTML = generateReadOnlyHTMLViewForQuoteGroup(groupIndex);
            let styles = "";
            document.querySelectorAll('style').forEach(styleTag => { styles += styleTag.innerHTML; });
            // Add styles specific to the provided example file for saved HTML
            styles += `
                .saved-html-view body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8F9FA; }
                .saved-html-view .day-header-container[onclick] { cursor: pointer; }
                .saved-html-view .day-header-container[onclick]:hover { background-color: #f0f0f0; }
                .saved-html-view .itinerary-planner-styles .card-image { width: 100px !important; height: 100px !important; object-fit: cover !important; }
                .saved-html-view .day-toggle-button-static svg { width: 1.25rem; height: 1.25rem; color: #4B5563; }
            `;

            const fontAwesomeLink = '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">';
            const tailwindCDN = '<link href="https://cdn.tailwindcss.com/2.2.19/dist/tailwind.min.css" rel="stylesheet">'; // Using existing Tailwind
            const googleFontLink = '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">';
            const htmlContent = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Í≤¨Ï†ÅÍ∑∏Î£π ÏÉÅÏÑ∏ÏùºÏ†ï: ${itineraryDataToSave.title || 'ÏùºÏ†ïÌëú'}</title>${tailwindCDN}${fontAwesomeLink}${googleFontLink}<style>${styles}</style></head><body class="text-gray-800 saved-html-view">${readOnlyViewHTML}<script type="application/json" id="embeddedTripData">${safeItineraryDataString}<\/script><script>function toggleDayView(headerElement) { const contentWrapper = headerElement.nextElementSibling; const toggleButtonSpan = headerElement.querySelector('.day-toggle-button-static svg'); if (contentWrapper && toggleButtonSpan) { const isHidden = contentWrapper.classList.toggle('hidden'); const expandedIconHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>'; const collapsedIconHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>'; toggleButtonSpan.innerHTML = isHidden ? collapsedIconHTML : expandedIconHTML;}}<\/script></body></html>`;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const groupTitle = groupData.groupTitle ? groupData.groupTitle.replace(/[^a-z0-9Í∞Ä-Ìû£]/gi, '_') : `Í∑∏Î£π${groupIndex}`;
            const fileName = `ÏÉÅÏÑ∏ÏùºÏ†ï_${groupTitle}_${dateToYyyyMmDd(new Date())}.html`;
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fileName;
            document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
            showToast('ÏÉÅÏÑ∏ ÏùºÏ†ïÏù¥ HTML ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
        }
        function handleSaveDetailedDayAsHtml(groupIndex, dayIndex) {
            // This function remains largely the same as its output is for a single day,
            // and the primary concern was the multi-day itinerary view.
            const groupData = quoteGroupDataStore[groupIndex]; if (!groupData || !groupData.detailedItinerary || !groupData.detailedItinerary.days[dayIndex]) { showToast('Ï†ÄÏû•Ìï† ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 3000, true); return; }
            const dayDataToSave = JSON.parse(JSON.stringify(groupData.detailedItinerary.days[dayIndex]));
            const dayDataString = JSON.stringify(dayDataToSave); const safeDayDataString = dayDataString.replace(/<\/script>/g, '<\\/script>');
            const readOnlyDayViewHTML = generateReadOnlyDayViewForQuoteGroup(groupIndex, dayIndex); //This function will use the updated styles.
            let styles = ""; document.querySelectorAll('style').forEach(styleTag => { styles += styleTag.innerHTML; });
             styles += `
                .saved-html-view body { font-family: 'Noto Sans KR', sans-serif; background-color: #F8F9FA; }
                .saved-html-view .readonly-view-header h1 { font-size: 1.25rem; }
                .saved-html-view .day-content-wrapper { display: block !important; }
                .saved-html-view .itinerary-planner-styles .card-image { width: 100px !important; height: 100px !important; object-fit:cover !important; }
            `;
            const fontAwesomeLink = '<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">';
            const tailwindCDN = '<link href="https://cdn.tailwindcss.com/2.2.19/dist/tailwind.min.css" rel="stylesheet">';
            const googleFontLink = '<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">';
            const htmlContent = `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>DAY ${dayIndex + 1} ÏÉÅÏÑ∏ (${dayDataToSave.date})</title>${tailwindCDN}${fontAwesomeLink}${googleFontLink}<style>${styles}</style></head><body class="text-gray-800 saved-html-view">${readOnlyDayViewHTML}<script type="application/json" id="embeddedTripDayData">${safeDayDataString}<\/script></body></html>`;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const groupTitle = groupData.groupTitle ? groupData.groupTitle.replace(/[^a-z0-9Í∞Ä-Ìû£]/gi, '_') : `Í∑∏Î£π${groupIndex}`;
            const fileName = `DAY${dayIndex + 1}_${groupTitle}_${dayDataToSave.date}.html`;
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = fileName;
            document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href);
            showToast(`DAY ${dayIndex + 1} ÏùºÏ†ïÏù¥ HTML ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.`);
        }

        // --- File Loading ---
        // These functions (handleLoadDetailedItineraryFromHtml, etc.) should remain largely the same
        // as they parse data, and the data structure hasn't fundamentally changed.
        function handleLoadDetailedItineraryFromHtml(groupIndex, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const htmlString = e.target.result; const parser = new DOMParser(); const doc = parser.parseFromString(htmlString, "text/html");
                    const embeddedDataElement = doc.getElementById('embeddedTripData');
                    if (embeddedDataElement && embeddedDataElement.textContent) {
                        const loadedData = JSON.parse(embeddedDataElement.textContent);
                        if (loadedData && Array.isArray(loadedData.days)) {
                            loadedData.days.forEach(day => {
                                if (day.date) { const validatedLoadedDate = parseAndFormatDateInput(String(day.date)); if (validatedLoadedDate && isValidYyyyMmDd(validatedLoadedDate)) day.date = validatedLoadedDate; else { console.warn(`Loaded HTML day date invalid: '${day.date}'. Defaulting to today.`); day.date = dateToYyyyMmDd(new Date()); }} else { console.warn("Loaded HTML day missing date. Setting to today."); day.date = dateToYyyyMmDd(new Date()); }
                                if (typeof day.isCollapsed === 'undefined') day.isCollapsed = false; if (typeof day.editingDate === 'undefined') day.editingDate = false;
                                day.activities.forEach(act => { if(!act.id) act.id = generateId(); });
                            });
                            if (typeof loadedData.title === 'undefined') loadedData.title = "Ïó¨Ìñâ ÏùºÏ†ïÌëú";
                            quoteGroupDataStore[groupIndex].detailedItinerary = loadedData;
                            document.querySelector(`input[name="detailed_itinerary_title[${groupIndex}]"]`).value = quoteGroupDataStore[groupIndex].detailedItinerary.title;
                            renderDetailedItineraryForGroup(groupIndex); showToast('HTML ÌååÏùºÏóêÏÑú ÏÉÅÏÑ∏ ÏùºÏ†ïÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                        } else { throw new Error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏûÖÎãàÎã§ (days Î∞∞Ïó¥ ÎàÑÎùΩ).'); }
                    } else { throw new Error('HTML ÌååÏùºÏóêÏÑú ÏÉÅÏÑ∏ ÏùºÏ†ï Îç∞Ïù¥ÌÑ∞(ID: embeddedTripData)Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'); }
                } catch (err) { console.error("HTML Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:", err); showToast(`Ïò§Î•ò: ${err.message}`, 3000, true); }};
            reader.onerror = () => { showToast('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò.', 3000, true); }; reader.readAsText(file);
        }
        function handleLoadDetailedDayFromHtml(groupIndex, dayIndexToOverwrite, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const htmlString = e.target.result; const parser = new DOMParser(); const doc = parser.parseFromString(htmlString, "text/html");
                    const embeddedDataElement = doc.getElementById('embeddedTripDayData');
                    if (embeddedDataElement && embeddedDataElement.textContent) {
                        const loadedDayData = JSON.parse(embeddedDataElement.textContent);
                        if (loadedDayData && loadedDayData.activities !== undefined) {
                            let finalDate = dateToYyyyMmDd(new Date());
                            if (loadedDayData.date) { const validatedLoadedDate = parseAndFormatDateInput(String(loadedDayData.date)); if (validatedLoadedDate && isValidYyyyMmDd(validatedLoadedDate)) finalDate = validatedLoadedDate; else { showToast(`Î∂àÎü¨Ïò® ÎÇ†Ïßú ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏïÑ (${loadedDayData.date}), ÌòÑÏû¨ ÎÇ†ÏßúÎ°ú ÏÑ§Ï†ïÌï©ÎãàÎã§.`, 4000, true); const existingDay = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite]; if (existingDay && existingDay.date && isValidYyyyMmDd(existingDay.date)) finalDate = existingDay.date; else finalDate = dateToYyyyMmDd(new Date()); }} else { showToast(`Î∂àÎü¨Ïò® Îç∞Ïù¥ÌÑ∞Ïóê ÎÇ†Ïßú Ï†ïÎ≥¥Í∞Ä ÏóÜÏñ¥, ÌòÑÏû¨ ÎÇ†ÏßúÎ°ú ÏÑ§Ï†ïÌï©ÎãàÎã§.`, 4000, true); const existingDay = quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite]; if (existingDay && existingDay.date && isValidYyyyMmDd(existingDay.date)) finalDate = existingDay.date; else finalDate = dateToYyyyMmDd(new Date()); }
                            loadedDayData.date = finalDate;
                            loadedDayData.activities.forEach(act => { if(!act.id) act.id = generateId(); });
                            if (!quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite]) quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite] = {};
                            quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite] = { ...quoteGroupDataStore[groupIndex].detailedItinerary.days[dayIndexToOverwrite], ...loadedDayData, isCollapsed: loadedDayData.isCollapsed !== undefined ? loadedDayData.isCollapsed : false, editingDate: false };
                            recalculateAllDetailedDates(groupIndex, dayIndexToOverwrite); renderDetailedItineraryForGroup(groupIndex);
                            showToast(`DAY ${dayIndexToOverwrite + 1} ÏùºÏ†ïÏùÑ Î∂àÎü¨Ïò® ÎÇ¥Ïö©ÏúºÎ°ú ÎçÆÏñ¥ÏçºÏäµÎãàÎã§.`);
                        } else { throw new Error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞ ÌòïÏãùÏûÖÎãàÎã§ (activities ÎàÑÎùΩ).'); }
                    } else { throw new Error('HTML ÌååÏùºÏóêÏÑú ÎÇ†Ïßú Îç∞Ïù¥ÌÑ∞(ID: embeddedTripDayData)Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'); }
                } catch (err) { console.error("ÎÇ†Ïßú HTML ÎçÆÏñ¥Ïì∞Í∏∞ Ïò§Î•ò:", err); showToast(`Ïò§Î•ò: ${err.message}`, 3000, true); }};
            reader.onerror = () => { showToast('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò.', 3000, true); }; reader.readAsText(file);
        }
        function handleLoadDetailedItineraryFromExcel(groupIndex, file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array', cellDates: true, dateNF:'yyyy-mm-dd'});
                    const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1, raw: false, defval: ""});
                    if (jsonData.length < 2) { throw new Error("ÏóëÏÖÄ ÌååÏùºÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò Ìó§ÎçîÎßå Ï°¥Ïû¨Ìï©ÎãàÎã§."); }
                    const newItinerary = { title: quoteGroupDataStore[groupIndex].detailedItinerary.title || "ÏóëÏÖÄÏóêÏÑú Í∞ÄÏ†∏Ïò® ÏùºÏ†ï", days: [] };
                    let currentDayObject = null; let errors = [];
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i]; const excelRowNumber = i + 1;
                        const rawDate = row[0] ? String(row[0]).trim() : ""; let time = row[1] ? String(row[1]).trim() : "";
                        if (time.includes(':')) time = time.replace(':', ''); if (time.length === 3) time = '0' + time;
                        const title = row[2] ? String(row[2]).trim() : ""; const description = row[3] ? String(row[3]).trim() : "";
                        const icon = row[4] ? String(row[4]).trim() : ""; const locationLink = row[5] ? String(row[5]).trim() : "";
                        const imageUrl = row[6] ? String(row[6]).trim() : ""; const cost = row[7] ? String(row[7]).trim() : ""; const notes = row[8] ? String(row[8]).trim() : "";
                        let formattedDate = ""; if (!rawDate) { errors.push(`${excelRowNumber}Ìñâ: ÎÇ†Ïßú(AÏó¥) ÎàÑÎùΩ.`); continue; }
                        let parsedDateObj = null;
                        if (typeof row[0] === 'number') { parsedDateObj = XLSX.SSF.parse_date_code(row[0]); if(parsedDateObj) formattedDate = `${parsedDateObj.y}-${String(parsedDateObj.m).padStart(2,'0')}-${String(parsedDateObj.d).padStart(2,'0')}`; }
                        else if (typeof rawDate === 'string') { const potentialDate = parseAndFormatDateInput(rawDate); if (potentialDate && isValidYyyyMmDd(potentialDate)) formattedDate = potentialDate; }
                        if (!formattedDate || !isValidYyyyMmDd(formattedDate)) { errors.push(`${excelRowNumber}Ìñâ: ÎÇ†Ïßú(AÏó¥) ÌòïÏãù Ïò§Î•ò ("${rawDate}").`); continue; }
                        if (!title) { errors.push(`${excelRowNumber}Ìñâ: ÌôúÎèôÎ™Ö(CÏó¥) ÎàÑÎùΩ.`); continue; }
                        if (time && (!/^\d{4}$/.test(time) || parseInt(time.substring(0,2),10) > 23 || parseInt(time.substring(2,4),10) > 59 )) { errors.push(`${excelRowNumber}Ìñâ: ÏãúÍ∞Ñ(BÏó¥) ÌòïÏãù Ïò§Î•ò ("${row[1]}"). ÏãúÍ∞Ñ Ï†ïÎ≥¥ ÏóÜÏù¥ ÏßÑÌñâ.`); time = "";}
                        if (!currentDayObject || currentDayObject.date !== formattedDate) { currentDayObject = { date: formattedDate, activities: [], isCollapsed: false, editingDate: false }; newItinerary.days.push(currentDayObject); }
                        currentDayObject.activities.forEach(act => { if(!act.id) act.id = generateId(); });
                        if (typeof currentDayObject.isCollapsed === 'undefined') currentDayObject.isCollapsed = false; if (typeof currentDayObject.editingDate === 'undefined') currentDayObject.editingDate = false;
                        currentDayObject.activities.push({ id: generateId(), time, icon, title, description, locationLink, imageUrl, cost, notes });
                    }
                    if (errors.length > 0) { showToast("ÏóëÏÖÄ Î∂àÎü¨Ïò§Í∏∞ Ï§ë ÏùºÎ∂Ä Ïò§Î•ò Î∞úÏÉù. ÏΩòÏÜî ÌôïÏù∏.", 3000, true); console.warn("ÏóëÏÖÄ Ïò§Î•ò:\n" + errors.join("\n")); }
                    if (newItinerary.days.length > 0) {
                        quoteGroupDataStore[groupIndex].detailedItinerary = newItinerary;
                        if (typeof quoteGroupDataStore[groupIndex].detailedItinerary.title === 'undefined') quoteGroupDataStore[groupIndex].detailedItinerary.title = "ÏóëÏÖÄÏóêÏÑú Í∞ÄÏ†∏Ïò® ÏùºÏ†ï";
                        quoteGroupDataStore[groupIndex].detailedItinerary.days.forEach(day => { if (typeof day.isCollapsed === 'undefined') day.isCollapsed = false; if (typeof day.editingDate === 'undefined') day.editingDate = false; day.activities.forEach(act => { if(!act.id) act.id = generateId(); }); });
                        document.querySelector(`input[name="detailed_itinerary_title[${groupIndex}]"]`).value = newItinerary.title;
                        renderDetailedItineraryForGroup(groupIndex); showToast('ÏóëÏÖÄÏóêÏÑú ÏÉÅÏÑ∏ ÏùºÏ†ïÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î∂àÎü¨ÏôîÏäµÎãàÎã§.');
                    } else if (errors.length === 0) { showToast('ÏóëÏÖÄ ÌååÏùºÏóê Ï≤òÎ¶¨Ìï† Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.', 3000, true); }
                } catch (err) { console.error("ÏóëÏÖÄ Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:", err); showToast(`ÏóëÏÖÄ ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò: ${err.message}`, 3000, true); }};
            reader.onerror = () => { showToast('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò.', 3000, true); }; reader.readAsArrayBuffer(file);
        }


        // ----- Ï¥àÍ∏∞Ìôî Î∞è Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà -----
        document.addEventListener('DOMContentLoaded', function() {
            enableSelectOnFocus('div.container');
            createQuoteGroup(quoteGroupCounter++);
            populateIconDropdown();

            document.getElementById('addGlobalQuoteGroupBtn').addEventListener('click', function() {
                const newGroupElement = createQuoteGroup(quoteGroupCounter++);
                if (newGroupElement) {
                    newGroupElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    const titleInputToFocus = newGroupElement.querySelector('input[name^="quote_group_title"]');
                    if (titleInputToFocus) setTimeout(() => titleInputToFocus.focus(), 300);
                }
            });

            document.getElementById('quoteGroupsContainer').addEventListener('click', function(e) {
                const target = e.target;
                const quoteGroupElement = target.closest('.quote-group-section');
                if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;

                if (target.closest('.add-detailed-itinerary-day-button')) handleAddDetailedItineraryDay(groupIndex);
                else if (target.closest('.add-activity-to-day-button')) { const dayIndex = target.closest('.add-activity-to-day-button').dataset.dayIndex; openActivityModal(groupIndex, parseInt(dayIndex)); }
                else if (target.closest('.edit-detailed-date-button')) { const dayIndex = parseInt(target.closest('.edit-detailed-date-button').dataset.dayIndex); handleEditDayDate(groupIndex, dayIndex); }
                else if (target.closest('.save-detailed-date-button')) { const dayIndex = parseInt(target.closest('.save-detailed-date-button').dataset.dayIndex); handleSaveDayDate(groupIndex, dayIndex); }
                else if (target.closest('.cancel-detailed-date-edit-button')) { const dayIndex = parseInt(target.closest('.cancel-detailed-date-edit-button').dataset.dayIndex); handleCancelEditDayDate(groupIndex, dayIndex); }
                else if (target.closest('.delete-detailed-day-button')) { const dayIndex = parseInt(target.closest('.delete-detailed-day-button').dataset.dayIndex); handleDeleteDetailedItineraryDay(groupIndex, dayIndex); }
                else if (target.closest('.toggle-detailed-day-collapse-button')) { const dayIndex = parseInt(target.closest('.toggle-detailed-day-collapse-button').dataset.dayIndex); handleToggleDayCollapse(groupIndex, dayIndex); }
                else if (target.closest('.edit-activity-button')) { const dayIndex = parseInt(target.closest('.edit-activity-button').dataset.dayIndex); const activityId = target.closest('.edit-activity-button').dataset.activityId; openActivityModal(groupIndex, dayIndex, activityId); }
                else if (target.closest('.duplicate-activity-button')) { const dayIndex = parseInt(target.closest('.duplicate-activity-button').dataset.dayIndex); const activityId = target.closest('.duplicate-activity-button').dataset.activityId; handleDuplicateActivity(groupIndex, dayIndex, activityId); }
                else if (target.closest('.delete-activity-button')) { const dayIndex = parseInt(target.closest('.delete-activity-button').dataset.dayIndex); const activityId = target.closest('.delete-activity-button').dataset.activityId; handleDeleteActivity(groupIndex, dayIndex, activityId); }
                else if (target.closest('.load-detailed-itinerary-html-btn')) { currentGroupIndexForLoad = groupIndex; document.getElementById('detailedItineraryHtmlLoadInput_main').click(); }
                else if (target.closest('.load-detailed-itinerary-excel-btn')) { currentGroupIndexForLoad = groupIndex; document.getElementById('detailedItineraryExcelLoadInput_main').click(); }
                else if (target.closest('.load-detailed-day-html-button')) { const dayIndex = parseInt(target.closest('.load-detailed-day-html-button').dataset.dayIndex); currentGroupIndexForLoad = groupIndex; currentDayIndexForLoad = dayIndex; document.getElementById('detailedDayHtmlLoadInput_main').click(); }
                else if (target.closest('.save-detailed-itinerary-html-btn')) { const grpIdx = target.closest('.save-detailed-itinerary-html-btn').dataset.groupIndex; handleSaveDetailedItineraryAsHtml(grpIdx); }
                else if (target.closest('.save-detailed-day-html-btn')) { const grpIdx = target.closest('.save-detailed-day-html-btn').dataset.groupIndex; const dayIdx = parseInt(target.closest('.save-detailed-day-html-btn').dataset.dayIndex); handleSaveDetailedDayAsHtml(grpIdx, dayIdx); }


                const priceSubgroupElement = target.closest('.price-subgroup');
                if (target.closest('.delete-quote-group-btn')) { if (window.confirm('Ïù¥ Í≤¨Ï†Å Í∑∏Î£π Ï†ÑÏ≤¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) { delete quoteGroupDataStore[groupIndex]; quoteGroupElement.remove();}}
                else if (target.closest('.copy-quote-group-btn')) {
                    const sourceGroupData = JSON.parse(JSON.stringify(quoteGroupDataStore[groupIndex]));
                    sourceGroupData.groupTitle = `${sourceGroupData.groupTitle} (Î≥µÏÇ¨Î≥∏)`;
                    if (sourceGroupData.detailedItinerary && sourceGroupData.detailedItinerary.days) {
                        sourceGroupData.detailedItinerary.days.forEach(day => {
                            if (day.activities) {
                                day.activities.forEach(activity => activity.id = generateId());
                            }
                        });
                    }
                    createQuoteGroup(quoteGroupCounter++, quoteGroupElement, sourceGroupData);
                    showToast('Í≤¨Ï†Å Í∑∏Î£πÏù¥ Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
                }
                else if (target.closest('.delete-dynamic-section-btn')) {
                    const dynamicSection = target.closest('.dynamic-section');
                    if (dynamicSection) {
                        const subGroupIndex = dynamicSection.dataset.subGroupIndex;
                        if (dynamicSection.classList.contains('price-subgroup')) { quoteGroupDataStore[groupIndex].priceSubgroups.splice(subGroupIndex, 1);}
                        else if (dynamicSection.classList.contains('flight-schedule-subgroup')) { quoteGroupDataStore[groupIndex].flightSubgroups.splice(subGroupIndex, 1); }
                        dynamicSection.remove();
                        if (dynamicSection.classList.contains('price-subgroup')) {
                            const remainingSubgroups = quoteGroupElement.querySelectorAll('.price-subgroup');
                            remainingSubgroups.forEach((sg, newIdx) => sg.dataset.subGroupIndex = newIdx);
                        } else if (dynamicSection.classList.contains('flight-schedule-subgroup')) {
                             const remainingSubgroups = quoteGroupElement.querySelectorAll('.flight-schedule-subgroup');
                            remainingSubgroups.forEach((sg, newIdx) => sg.dataset.subGroupIndex = newIdx);
                        }

                        if (priceSubgroupElement) { const parentPriceSubgroup = dynamicSection.closest('.price-subgroup'); if(parentPriceSubgroup) updateGrandTotalForSubgroup(parentPriceSubgroup); }
                    }
                } else if (target.closest('.delete-row')) {
                    const row = target.closest('tr'); const tableBody = row.parentElement; const subGroupElement = target.closest('.dynamic-section');
                    if(row && subGroupElement){
                        const groupIdx = subGroupElement.dataset.groupIndex; const subGroupIndex = subGroupElement.dataset.subGroupIndex;
                        const rowIndex = Array.from(tableBody.children).indexOf(row);
                        if(subGroupElement.classList.contains('price-subgroup')){ quoteGroupDataStore[groupIdx].priceSubgroups[subGroupIndex].rows.splice(rowIndex, 1); updateGrandTotalForSubgroup(subGroupElement); }
                        else if (subGroupElement.classList.contains('flight-schedule-subgroup')){ quoteGroupDataStore[groupIdx].flightSubgroups[subGroupIndex].rows.splice(rowIndex, 1);}
                        row.remove();
                    } else if (row && tableBody.id.startsWith('itineraryTableBody_')) {
                        const groupIdx = target.closest('.quote-group-section').dataset.groupIndex;
                        const rowIndex = Array.from(tableBody.children).indexOf(row);
                        quoteGroupDataStore[groupIdx].itinerarySummaryRows.splice(rowIndex, 1); row.remove();
                    }
                } else if (target.closest('.add-itinerary-row-to-group')) {
                    const itineraryTbody = quoteGroupElement.querySelector(`#itineraryTableBody_${groupIndex}`);
                    const newRowData = { dayNo: "", dayDate: "", sCity: "", eCity: "", hotel: "", traffic: "", bigo: "" };
                    if (!quoteGroupDataStore[groupIndex].itinerarySummaryRows) quoteGroupDataStore[groupIndex].itinerarySummaryRows = [];
                    quoteGroupDataStore[groupIndex].itinerarySummaryRows.push(newRowData);
                    addItineraryRowForGroupUI(itineraryTbody, groupIndex, newRowData.dayNo, newRowData.dayDate, newRowData.sCity, newRowData.eCity, newRowData.hotel, newRowData.traffic, newRowData.bigo);
                }
            });

             document.getElementById('quoteGroupsContainer').addEventListener('input', function(e) {
                const target = e.target; const quoteGroupElement = target.closest('.quote-group-section'); if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;
                if (target.matches('input[name^="quote_group_title"]')) { quoteGroupDataStore[groupIndex].groupTitle = target.value;}
                else if (target.matches('textarea[name^="included_items_textarea"]')) { quoteGroupDataStore[groupIndex].inclusionExclusion.includedTextarea = target.value;}
                else if (target.matches('textarea[name^="excluded_items_textarea"]')) { quoteGroupDataStore[groupIndex].inclusionExclusion.excludedTextarea = target.value;}
                else if (target.matches('input[name^="price_subgroup_title"]')) {
                    const subGroupElement = target.closest('.price-subgroup');
                    if (subGroupElement) {
                        const subGroupIndex = subGroupElement.dataset.subGroupIndex;
                        if(quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex]) {
                           quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].title = target.value;
                        }
                    }
                }
                else if (target.matches('input[name^="flight_group_title"]')) {
                    const subGroupElement = target.closest('.flight-schedule-subgroup');
                     if (subGroupElement) {
                        const subGroupIndex = subGroupElement.dataset.subGroupIndex;
                        if(quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex]) {
                           quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].title = target.value;
                        }
                    }
                }
                else if (target.classList.contains('flight-schedule-input')) {
                    const subGroupElement = target.closest('.flight-schedule-subgroup'); const subGroupIndex = subGroupElement.dataset.subGroupIndex;
                    const rowElement = target.closest('tr'); const rowIndex = Array.from(rowElement.parentElement.children).indexOf(rowElement);
                    const field = target.dataset.field;
                    if(quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex] && quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows[rowIndex]) quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows[rowIndex][field] = target.value;
                } else if (target.classList.contains('itinerary-schedule-input')) {
                    const rowElement = target.closest('tr'); const rowIndex = Array.from(rowElement.parentElement.children).indexOf(rowElement);
                    const field = target.dataset.field; if (quoteGroupDataStore[groupIndex].itinerarySummaryRows[rowIndex]) quoteGroupDataStore[groupIndex].itinerarySummaryRows[rowIndex][field] = target.value;
                } else if (target.matches('input[name^="detailed_itinerary_title"]')) { if (quoteGroupDataStore[groupIndex] && quoteGroupDataStore[groupIndex].detailedItinerary) quoteGroupDataStore[groupIndex].detailedItinerary.title = target.value;}

                if (target.matches('.price-per-person, .person-count, input[name*="p_title"], input[name*="p_bigo"]')) {
                    const subgroupElement = target.closest('.price-subgroup');
                    if (subgroupElement) {
                        const rowElement = target.closest('tr');
                        const rowIndex = Array.from(rowElement.parentElement.children).indexOf(rowElement);
                        const subGroupIndex = subgroupElement.dataset.subGroupIndex;

                        const priceRow = quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows[rowIndex];
                        if (priceRow) {
                            if (target.matches('.price-per-person')) priceRow.perPrice = target.value;
                            else if (target.matches('.person-count')) priceRow.number = target.value;
                            else if (target.name.includes('p_title')) priceRow.title = target.value;
                            else if (target.name.includes('p_bigo')) priceRow.bigo = target.value;
                        }
                        updateRowTotalForSubgroup({target: target}, subgroupElement);
                    }
                }
            });

             document.getElementById('quoteGroupsContainer').addEventListener('paste', function(e) {
                const targetInput = e.target; const quoteGroupElement = targetInput.closest('.quote-group-section'); if (!quoteGroupElement) return;
                const groupIndex = quoteGroupElement.dataset.groupIndex;
                if (targetInput.matches('.flight-schedule-input')) { const flightSubgroupElement = targetInput.closest('.flight-schedule-subgroup'); if (flightSubgroupElement) { const subGroupIndex = flightSubgroupElement.dataset.subGroupIndex; handlePasteToFlightTableForSubgroup(e, groupIndex, subGroupIndex);}}
                else if (targetInput.matches('.itinerary-schedule-input')) { const itineraryTableBody = targetInput.closest('tbody.itinerary-table-body-for-group'); if (itineraryTableBody) handlePasteToItineraryTableForGroup(e, itineraryTableBody, groupIndex); }
            });

            document.getElementById('detailedItineraryHtmlLoadInput_main').addEventListener('change', function(event) { if (currentGroupIndexForLoad === null) return; const file = event.target.files[0]; if (file) handleLoadDetailedItineraryFromHtml(currentGroupIndexForLoad, file); this.value = null; currentGroupIndexForLoad = null;});
            document.getElementById('detailedItineraryExcelLoadInput_main').addEventListener('change', function(event) { if (currentGroupIndexForLoad === null) return; const file = event.target.files[0]; if (file) handleLoadDetailedItineraryFromExcel(currentGroupIndexForLoad, file); this.value = null; currentGroupIndexForLoad = null; });
            document.getElementById('detailedDayHtmlLoadInput_main').addEventListener('change', function(event) { if (currentGroupIndexForLoad === null || currentDayIndexForLoad === null) return; const file = event.target.files[0]; if (file) handleLoadDetailedDayFromHtml(currentGroupIndexForLoad, currentDayIndexForLoad, file); this.value = null; currentGroupIndexForLoad = null; currentDayIndexForLoad = null;});

            document.getElementById('loadQuoteFile').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const fullHtml = e.target.result;
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(fullHtml, "text/html");

                            const dataScript = doc.getElementById('fullQuoteData');
                            if (dataScript && dataScript.textContent) {
                                const data = JSON.parse(dataScript.textContent);
                                restoreEditorFromData(data);
                            } else {
                                console.warn("Ï†ÑÏ≤¥ Í≤¨Ï†Å Îç∞Ïù¥ÌÑ∞ ÌÉúÍ∑∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. DOMÏóêÏÑú ÏàòÎèô ÌååÏã± ÏãúÎèÑ (Ï†úÌïúÏ†Å).");
                                manualParseAndRestore(doc);
                                showToast("HTMLÏóêÏÑú ÏùºÎ∂Ä Ï†ïÎ≥¥Î•º Î∂àÎü¨ÏôîÏäµÎãàÎã§ (Ï†úÌïúÏ†Å).", 4000);
                            }
                        } catch (err) {
                            console.error("Í≤¨Ï†Å Î∂àÎü¨Ïò§Í∏∞ Ïò§Î•ò:", err);
                            showToast("Í≤¨Ï†Å ÌååÏùº Î∂àÎü¨Ïò§Í∏∞ Ï§ë Ïò§Î•ò Î∞úÏÉù: " + err.message, 5000, true);
                        }
                    };
                    reader.readAsText(file);
                    this.value = null;
                }
            });
        });

        function enableSelectOnFocus(containerSelector = 'body') {
            const container = document.querySelector(containerSelector); if (!container) return;
            container.addEventListener('focusin', function(event) {
                const target = event.target;
                if (target.matches('input[type="text"], input[type="email"], input[type="number"], textarea')) { if (typeof target.select === 'function' && !target.isContentEditable) setTimeout(() => { target.select(); }, 0); }
            });
        }

        // ----- ÏöîÍ∏à ÏÑπÏÖò -----
        function initPriceSectionForGroup(quoteGroupElement, groupIndex, sourcePriceSubgroups = null) {
            const addPriceSubgroupButton = quoteGroupElement.querySelector('.add-price-subgroup-button');
            const priceSectionsContainer = quoteGroupElement.querySelector(`#priceSectionsContainer_${groupIndex}`);
            if (!quoteGroupDataStore[groupIndex].priceSubgroups) { quoteGroupDataStore[groupIndex].priceSubgroups = []; }
            let currentSubgroups = quoteGroupDataStore[groupIndex].priceSubgroups;
            if (addPriceSubgroupButton) {
                 addPriceSubgroupButton.addEventListener('click', () => {
                    const newSubgroupData = {title: "", rows: [ { title: "ÏÑ±Ïù∏ÏöîÍ∏à", perPrice: "0", number: 1, bigo: "" }, { title: "ÏÜåÏïÑÏöîÍ∏à", perPrice: "0", number: 0, bigo: "2~12ÏÑ∏ÎØ∏Îßå(Ï¢åÏÑùÏ†êÏú†)" }, { title: "Ïú†ÏïÑÏöîÍ∏à", perPrice: "0", number: 0, bigo: "24Í∞úÏõîÎØ∏Îßå(Ï¢åÏÑùÎØ∏Ï†êÏú†)" } ]};
                    currentSubgroups.push(newSubgroupData);
                    createPriceSubgroup(priceSectionsContainer, groupIndex, currentSubgroups.length - 1, newSubgroupData);
                });
            }
            if (currentSubgroups.length > 0) { currentSubgroups.forEach((subgroupData, idx) => createPriceSubgroup(priceSectionsContainer, groupIndex, idx, subgroupData)); }
            else { const defaultSubgroupData = {title: "", rows: [ { title: "ÏÑ±Ïù∏ÏöîÍ∏à", perPrice: "0", number: 1, bigo: "" }, { title: "ÏÜåÏïÑÏöîÍ∏à", perPrice: "0", number: 0, bigo: "2~12ÏÑ∏ÎØ∏Îßå(Ï¢åÏÑùÏ†êÏú†)" }, { title: "Ïú†ÏïÑÏöîÍ∏à", perPrice: "0", number: 0, bigo: "24Í∞úÏõîÎØ∏Îßå(Ï¢åÏÑùÎØ∏Ï†êÏú†)" } ]}; currentSubgroups.push(defaultSubgroupData); createPriceSubgroup(priceSectionsContainer, groupIndex, 0, defaultSubgroupData); }
        }
        function createPriceSubgroup(container, groupIndex, subGroupIndex, sourceSubgroupData = null) {
            const sectionId = `priceSection_${groupIndex}_${subGroupIndex}`; const tableBodyId = `priceTableBody_${groupIndex}_${subGroupIndex}`; const grandTotalId = `grandTotal_${groupIndex}_${subGroupIndex}`; const groupTitleInputName = `price_subgroup_title[${groupIndex}][${subGroupIndex}]`;
            const sectionDiv = document.createElement('div'); sectionDiv.className = 'dynamic-section price-subgroup'; sectionDiv.id = sectionId; sectionDiv.dataset.groupIndex = groupIndex; sectionDiv.dataset.subGroupIndex = subGroupIndex;
            const initialSubgroupTitle = sourceSubgroupData ? sourceSubgroupData.title : "";
            sectionDiv.innerHTML = `<button type="button" class="delete-dynamic-section delete-dynamic-section-btn text-red-500 hover:text-red-700" title="Ïù¥ ÏöîÍ∏à ÏÜåÍ∑∏Î£π ÏÇ≠Ï†ú"><i class="fas fa-trash-alt mr-1"></i>ÏÇ≠Ï†ú</button><div class="mb-2"><input type="text" name="${groupTitleInputName}" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-md font-semibold" placeholder="Í≤¨Ï†ÅÏÑ§Î™Ö (Ïòà: Ïù∏Ï≤úÏ∂úÎ∞ú, ÍπÄÌï¥Ï∂úÎ∞ú, AÍ∞ùÏã§, BÍ∞ùÏã§)" value="${initialSubgroupTitle}"></div><div class="overflow-x-auto"><table class="min-w-full bg-white border price-table text-sm"><thead><tr class="bg-gray-100"><th class="border p-2 text-center" style="width: 20%;">ÎÇ¥Ïó≠</th><th class="border p-2 text-center" style="width: 15%;">1Ïù∏Îãπ Í∏àÏï°</th><th class="border p-2 text-center" style="width: 8%;">Ïù∏Ïõê</th><th class="border p-2 text-center" style="width: 17%;">Ï¥ù Í∏àÏï°</th><th class="border p-2 text-center">ÎπÑÍ≥†</th><th class="border p-2 text-center w-12">ÏÇ≠Ï†ú</th></tr></thead><tbody id="${tableBodyId}" class="price-table-body"></tbody><tfoot><tr><td colspan="3" class="border p-2 text-right font-bold text-xs">Ï¥ù Ìï©Í≥Ñ</td><td class="border p-1 font-bold"><input type="text" name="p_sumprice[${groupIndex}][${subGroupIndex}]" id="${grandTotalId}" class="w-full border-0 focus:ring-0 grand-total-input text-xs p-1 text-right" value="0" readonly></td><td colspan="2" class="border p-2"><button type="button" class="add-price-row-to-subgroup bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs"><i class="fas fa-plus mr-1"></i> Ìñâ Ï∂îÍ∞Ä</button></td></tr></tfoot></table></div>`;
            container.appendChild(sectionDiv); const tbody = sectionDiv.querySelector('.price-table-body');
            const rowsToRender = (sourceSubgroupData && sourceSubgroupData.rows && sourceSubgroupData.rows.length > 0) ? sourceSubgroupData.rows : [ { title: "ÏÑ±Ïù∏ÏöîÍ∏à", perPrice: "0", number: 1, bigo: "" }, { title: "ÏÜåÏïÑÏöîÍ∏à", perPrice: "0", number: 0, bigo: "2~12ÏÑ∏ÎØ∏Îßå(Ï¢åÏÑùÏ†êÏú†)" }, { title: "Ïú†ÏïÑÏöîÍ∏à", perPrice: "0", number: 0, bigo: "24Í∞úÏõîÎØ∏Îßå(Ï¢åÏÑùÎØ∏Ï†êÏú†)" } ];
            rowsToRender.forEach(rowData => addPriceRowToExistingSubgroup(null, sectionDiv, rowData)); initPriceTableForSubgroup(sectionDiv); return sectionDiv;
        }
        function initPriceTableForSubgroup(subgroupElement) { subgroupElement.querySelectorAll('.price-table-body tr').forEach(row => { const firstInput = row.querySelector('.price-per-person'); if (firstInput) updateRowTotalForSubgroup({ target: firstInput }, subgroupElement); }); const addRowButton = subgroupElement.querySelector('.add-price-row-to-subgroup'); if (addRowButton) addRowButton.addEventListener('click', (e) => addPriceRowToExistingSubgroup(e, subgroupElement)); }
        function updateRowTotalForSubgroup(event, subgroupElement) { const row = event.target.closest('tr'); if (!row) return; const pricePerPersonInput = row.querySelector('.price-per-person'); const personCountInput = row.querySelector('.person-count'); const totalPriceInput = row.querySelector('.total-price'); if (!pricePerPersonInput || !personCountInput || !totalPriceInput) return; const pricePerPerson = parseFloat(pricePerPersonInput.value) || 0; const personCount = parseInt(personCountInput.value) || 0; totalPriceInput.value = (pricePerPerson * personCount).toLocaleString(); updateGrandTotalForSubgroup(subgroupElement); }
        function updateGrandTotalForSubgroup(subgroupElement) { let grandTotal = 0; subgroupElement.querySelectorAll('.price-table-body .total-price').forEach(cell => grandTotal += parseFloat(cell.value.replace(/,/g, '')) || 0); const grandTotalInput = subgroupElement.querySelector('.grand-total-input'); if (grandTotalInput) grandTotalInput.value = grandTotal.toLocaleString(); }
        function addPriceRowToExistingSubgroup(event, subgroupElement, rowData = null) { const tbody = subgroupElement.querySelector('.price-table-body'); const groupIndex = subgroupElement.dataset.groupIndex; const subGroupIndex = subgroupElement.dataset.subGroupIndex; if (!tbody || groupIndex === undefined || subGroupIndex === undefined) return; const titleVal = rowData ? rowData.title : "Ï∂îÍ∞Ä ÎπÑÏö©"; const perPriceVal = rowData ? rowData.perPrice : "0"; const numberVal = rowData ? rowData.number : "1"; const bigoVal = rowData ? rowData.bigo : ""; const tr = document.createElement('tr'); tr.innerHTML = `<td class="border p-1"><input type="text" name="p_title[${groupIndex}][${subGroupIndex}][]" value="${titleVal}" class="w-full border-0 focus:ring-0 text-xs p-1"></td><td class="border p-1"><input type="number" name="p_perprice[${groupIndex}][${subGroupIndex}][]" class="price-per-person w-full border-0 focus:ring-0 text-xs p-1 text-right" value="${perPriceVal}"></td><td class="border p-1"><input type="number" name="p_number[${groupIndex}][${subGroupIndex}][]" class="person-count w-full border-0 focus:ring-0 text-xs p-1 text-center" value="${numberVal}"></td><td class="border p-1"><input type="text" name="p_totalprice[${groupIndex}][${subGroupIndex}][]" class="w-full border-0 focus:ring-0 total-price text-xs p-1 text-right" value="0" readonly></td><td class="border p-1"><input type="text" name="p_bigo[${groupIndex}][${subGroupIndex}][]" class="w-full border-0 focus:ring-0 text-xs p-1" value="${bigoVal}"></td><td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700 text-xs" title="ÏÇ≠Ï†ú"><i class="fas fa-trash"></i></button></td>`; tbody.appendChild(tr); const firstInput = tr.querySelector('.price-per-person'); if (firstInput) updateRowTotalForSubgroup({ target: firstInput }, subgroupElement); if (event) { if (!quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows) { quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows = []; } quoteGroupDataStore[groupIndex].priceSubgroups[subGroupIndex].rows.push({ title: titleVal, perPrice: perPriceVal, number: numberVal, bigo: bigoVal }); } }

        // ----- Ìï≠Í≥µ Ïä§ÏºÄÏ§Ñ ÏÑπÏÖò -----
        function initFlightScheduleForGroup(quoteGroupElement, groupIndex, sourceFlightSubgroups = null) {
            const addFlightSubgroupButton = quoteGroupElement.querySelector('.add-flight-subgroup-button'); const flightScheduleContainer = quoteGroupElement.querySelector(`#flightScheduleGroupsContainer_${groupIndex}`);
            if (!quoteGroupDataStore[groupIndex].flightSubgroups) { quoteGroupDataStore[groupIndex].flightSubgroups = []; } let currentSubgroups = quoteGroupDataStore[groupIndex].flightSubgroups;
            if (addFlightSubgroupButton) { addFlightSubgroupButton.addEventListener('click', () => { const newSubgroupData = { title: "", rows: [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }] }; currentSubgroups.push(newSubgroupData); createFlightSubgroup(flightScheduleContainer, groupIndex, currentSubgroups.length - 1, newSubgroupData); }); }
            if (currentSubgroups.length > 0) { currentSubgroups.forEach((subgroupData, idx) => createFlightSubgroup(flightScheduleContainer, groupIndex, idx, subgroupData)); }
            else { const defaultSubgroupData = { title: "", rows: [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }] }; currentSubgroups.push(defaultSubgroupData); createFlightSubgroup(flightScheduleContainer, groupIndex, 0, defaultSubgroupData); }
        }
        function createFlightSubgroup(container, groupIndex, subGroupIndex, sourceSubgroupData = null) {
            const groupId = `flightScheduleGroup_${groupIndex}_${subGroupIndex}`; const tableBodyId = `flightTableBody_${groupIndex}_${subGroupIndex}`; const groupTitleInputName = `flight_group_title[${groupIndex}][${subGroupIndex}]`; const groupDiv = document.createElement('div'); groupDiv.className = 'dynamic-section flight-schedule-subgroup'; groupDiv.id = groupId; groupDiv.dataset.groupIndex = groupIndex; groupDiv.dataset.subGroupIndex = subGroupIndex;
            const initialTitle = sourceSubgroupData ? sourceSubgroupData.title : ""; groupDiv.innerHTML = `<button type="button" class="delete-dynamic-section delete-dynamic-section-btn text-red-500 hover:text-red-700" title="Ïù¥ Ìï≠Í≥µ Ïä§ÏºÄÏ§Ñ ÏÜåÍ∑∏Î£π ÏÇ≠Ï†ú"><i class="fas fa-trash-alt mr-1"></i>ÏÇ≠Ï†ú</button><div class="mb-2"><input type="text" name="${groupTitleInputName}" class="w-full px-3 py-2 border rounded focus:outline-none focus:border-custom-orange text-md font-semibold" placeholder="Ìï≠Í≥µÏÇ¨ (Ïòà: Ïù¥Ïä§ÌÉÄÌï≠Í≥µ)" value="${initialTitle}"></div><div class="overflow-x-auto"><table class="min-w-full bg-white border text-sm"><thead><tr class="bg-gray-100"><th class="border p-2 text-left text-xs">Ìé∏Î™Ö</th><th class="border p-2 text-left text-xs">Ï∂úÎ∞úÏùº</th><th class="border p-2 text-left text-xs">Ï∂úÎ∞úÏßÄ</th><th class="border p-2 text-left text-xs">Ï∂úÎ∞úÏãúÍ∞Ñ</th><th class="border p-2 text-left text-xs">ÎèÑÏ∞©Ïùº</th><th class="border p-2 text-left text-xs">ÎèÑÏ∞©ÏßÄ</th><th class="border p-2 text-left text-xs">ÎèÑÏ∞©ÏãúÍ∞Ñ</th><th class="border p-2 text-center w-12 text-xs">ÏÇ≠Ï†ú</th></tr></thead><tbody id="${tableBodyId}" class="flight-table-body-subgroup"></tbody><tfoot><tr><td colspan="8" class="border p-2"><button type="button" class="add-flight-row-to-subgroup bg-custom-green text-white px-2 py-1 rounded hover:bg-opacity-90 transition text-xs"><i class="fas fa-plus mr-1"></i> Ìñâ Ï∂îÍ∞Ä</button></td></tr></tfoot></table></div>`;
            container.appendChild(groupDiv); const tbody = groupDiv.querySelector(`#${tableBodyId}`);
            const rowsToRender = (sourceSubgroupData && sourceSubgroupData.rows && sourceSubgroupData.rows.length > 0) ? sourceSubgroupData.rows : [{ flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }];
            rowsToRender.forEach(rowData => { addFlightRowForSubgroup(tbody, groupIndex, subGroupIndex, rowData.flightNum, rowData.depDate, rowData.originCity, rowData.depTime, rowData.arrDate, rowData.destCity, rowData.arrTime); });
            const addFlightRowButton = groupDiv.querySelector('.add-flight-row-to-subgroup'); if(addFlightRowButton) { addFlightRowButton.addEventListener('click', () => { const targetTbody = groupDiv.querySelector('tbody.flight-table-body-subgroup'); if (targetTbody) { const newRowData = { flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }; quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex].rows.push(newRowData); addFlightRowForSubgroup(targetTbody, groupIndex, subGroupIndex); } }); }
            groupDiv.addEventListener('paste', (e) => handlePasteToFlightTableForSubgroup(e, groupIndex, subGroupIndex)); return groupDiv;
        }
        function addFlightRowForSubgroup(tbodyElement, groupIndex, subGroupIndex, flightNum = "", depDate = "", originCity = "", depTime = "", arrDate = "", destCity = "", arrTime = "") {
            if (!tbodyElement) return null; const tr = document.createElement('tr'); tr.innerHTML = `<td class="border p-1"><input type="text" name="dep_trans_flight_group[${groupIndex}][${subGroupIndex}][]" data-field="flightNum" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${flightNum}" placeholder="ZE 561"></td><td class="border p-1"><input type="text" name="start_day_group[${groupIndex}][${subGroupIndex}][]" data-field="depDate" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${depDate}" placeholder="07Ïõî 09Ïùº"></td><td class="border p-1"><input type="text" name="dep_start_city_cd_group[${groupIndex}][${subGroupIndex}][]" data-field="originCity" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${originCity}" placeholder="Ïù∏Ï≤ú"></td><td class="border p-1"><input type="text" name="dep_start_time_group[${groupIndex}][${subGroupIndex}][]" data-field="depTime" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${depTime}" placeholder="20:55"></td><td class="border p-1"><input type="text" name="arrival_day_group[${groupIndex}][${subGroupIndex}][]" data-field="arrDate" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${arrDate}" placeholder="07Ïõî 09Ïùº"></td><td class="border p-1"><input type="text" name="dep_end_city_cd_group[${groupIndex}][${subGroupIndex}][]" data-field="destCity" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${destCity}" placeholder="ÎÇòÌä∏Îûë"></td><td class="border p-1"><input type="text" name="dep_end_time_group[${groupIndex}][${subGroupIndex}][]" data-field="arrTime" class="w-full border-0 focus:ring-0 flight-schedule-input text-xs p-1" value="${arrTime}" placeholder="23:55"></td><td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700 text-xs" title="ÏÇ≠Ï†ú"><i class="fas fa-trash"></i></button></td>`;
            tbodyElement.appendChild(tr); return tr;
        }
        function initInclusionExclusionForGroup(quoteGroupElement, groupIndex, sourceData = null) { /* Empty, but preserved structure */ }
        function initItinerarySummaryForGroup(quoteGroupElement, groupIndex, sourceItineraryRows = null) {
            const tbody = quoteGroupElement.querySelector(`#itineraryTableBody_${groupIndex}`); tbody.innerHTML = '';
            if (!quoteGroupDataStore[groupIndex].itinerarySummaryRows) { quoteGroupDataStore[groupIndex].itinerarySummaryRows = []; }
            if (sourceItineraryRows && sourceItineraryRows.length > 0 && quoteGroupDataStore[groupIndex].itinerarySummaryRows.length === 0) { quoteGroupDataStore[groupIndex].itinerarySummaryRows = JSON.parse(JSON.stringify(sourceItineraryRows)); }
            quoteGroupDataStore[groupIndex].itinerarySummaryRows.forEach(rowData => { addItineraryRowForGroupUI(tbody, groupIndex, rowData.dayNo, rowData.dayDate, rowData.sCity, rowData.eCity, rowData.hotel, rowData.traffic, rowData.bigo); });
        }
        function addItineraryRowForGroupUI(tbodyElement, groupIndex, dayNoVal = "", dayDateVal = "", sCityVal = "", eCityVal = "", hotelVal = "", trafficVal = "", bigoVal = "") {
            if (!tbodyElement) { console.error("tbodyElement is null in addItineraryRowForGroupUI for groupIndex:", groupIndex); return null; }
            const tr = document.createElement('tr'); tr.innerHTML = `<td class="border p-1"><input type="text" name="schdule_no[${groupIndex}][]" data-field="dayNo" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${dayNoVal}" placeholder="1"></td><td class="border p-1"><input type="text" name="schdule_day[${groupIndex}][]" data-field="dayDate" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${dayDateVal}" placeholder="12Ïõî 28Ïùº"></td><td class="border p-1"><input type="text" name="schdule_scity[${groupIndex}][]" data-field="sCity" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${sCityVal}" placeholder="Ïù∏Ï≤ú"></td><td class="border p-1"><input type="text" name="schdule_ecity[${groupIndex}][]" data-field="eCity" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${eCityVal}" placeholder="Ìë∏Íæ∏Ïò•"></td><td class="border p-1"><input type="text" name="schdule_hotel[${groupIndex}][]" data-field="hotel" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${hotelVal}" placeholder="Î≤ÑÍ≥†Ìò∏ÌÖî"></td><td class="border p-1"><input type="text" name="schdule_traffic[${groupIndex}][]" data-field="traffic" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${trafficVal}" placeholder="Ìï≠Í≥µ"></td><td class="border p-1"><input type="text" name="schdule_bigo[${groupIndex}][]" data-field="bigo" class="w-full border-0 focus:ring-0 itinerary-schedule-input text-xs p-1" value="${bigoVal}"></td><td class="border p-1 text-center"><button type="button" class="delete-row text-red-500 hover:text-red-700 text-xs" title="ÏÇ≠Ï†ú"><i class="fas fa-trash"></i></button></td>`;
            tbodyElement.appendChild(tr); return tr;
        }
        function handlePasteToFlightTableForSubgroup(event, groupIndex, subGroupIndex) {
            const targetInput = event.target; if (!targetInput.matches('.flight-schedule-input')) return; event.preventDefault();
            const pasteData = (event.clipboardData || window.clipboardData).getData('text/plain'); const rowsOfData = pasteData.split(/\r\n|\n|\r/);
            let currentRowElement = targetInput.closest('tr'); let currentCellIndexInRow = Array.from(currentRowElement.cells).indexOf(targetInput.closest('td'));
            const currentTbody = currentRowElement.closest('tbody.flight-table-body-subgroup'); const flightSubgroupData = quoteGroupDataStore[groupIndex].flightSubgroups[subGroupIndex];
            rowsOfData.forEach((rowText, pasteRowIndex) => {
                if (!rowText.trim()) return; const cellsOfData = rowText.split('\t'); let currentTbodyRowIndex = Array.from(currentTbody.children).indexOf(currentRowElement);
                if (!currentRowElement) { const newRowData = { flightNum: "", depDate: "", originCity: "", depTime: "", arrDate: "", destCity: "", arrTime: "" }; flightSubgroupData.rows.push(newRowData); currentRowElement = addFlightRowForSubgroup(currentTbody, groupIndex, subGroupIndex); if (!currentRowElement) return; currentCellIndexInRow = 0; currentTbodyRowIndex = flightSubgroupData.rows.length -1; }
                const inputFieldsInCurrentRow = currentRowElement.querySelectorAll('.flight-schedule-input'); let dataCellIdx = 0;
                for (let i = currentCellIndexInRow; i < inputFieldsInCurrentRow.length && dataCellIdx < cellsOfData.length; i++) { const fieldName = inputFieldsInCurrentRow[i].dataset.field; const pastedValue = cellsOfData[dataCellIdx].trim(); inputFieldsInCurrentRow[i].value = pastedValue; if (flightSubgroupData.rows[currentTbodyRowIndex]) { flightSubgroupData.rows[currentTbodyRowIndex][fieldName] = pastedValue; } dataCellIdx++; }
                const nextTRElement = currentRowElement.nextElementSibling; currentRowElement = (nextTRElement && nextTRElement.cells.length > 0) ? nextTRElement : null; currentCellIndexInRow = 0;
            });
        }
        function handlePasteToItineraryTableForGroup(event, tbodyElement, groupIndex) {
            const targetInput = event.target; if (!targetInput.matches('.itinerary-schedule-input')) return; event.preventDefault();
            const pasteData = (event.clipboardData || window.clipboardData).getData('text/plain'); const rowsOfData = pasteData.split(/\r\n|\n|\r/);
            let currentRowElement = targetInput.closest('tr'); let currentCellIndexInRow = Array.from(currentRowElement.cells).indexOf(targetInput.closest('td'));
            const summaryRowsData = quoteGroupDataStore[groupIndex].itinerarySummaryRows;
            rowsOfData.forEach((rowText, pasteRowIndex) => {
                if (!rowText.trim()) return; const cellsOfData = rowText.split('\t'); let currentTbodyRowIndex = Array.from(tbodyElement.children).indexOf(currentRowElement);
                if (!currentRowElement) { const newRowData = { dayNo: "", dayDate: "", sCity: "", eCity: "", hotel: "", traffic: "", bigo: "" }; summaryRowsData.push(newRowData); currentRowElement = addItineraryRowForGroupUI(tbodyElement, groupIndex); if (!currentRowElement) return; currentCellIndexInRow = 0; currentTbodyRowIndex = summaryRowsData.length -1; }
                const inputFieldsInCurrentRow = currentRowElement.querySelectorAll('.itinerary-schedule-input'); let dataCellIdx = 0;
                for (let i = currentCellIndexInRow; i < inputFieldsInCurrentRow.length && dataCellIdx < cellsOfData.length; i++) { const fieldName = inputFieldsInCurrentRow[i].dataset.field; const pastedValue = cellsOfData[dataCellIdx].trim(); inputFieldsInCurrentRow[i].value = pastedValue; if (summaryRowsData[currentTbodyRowIndex]) { summaryRowsData[currentTbodyRowIndex][fieldName] = pastedValue; } dataCellIdx++; }
                const nextTRElement = currentRowElement.nextElementSibling; currentRowElement = (nextTRElement && nextTRElement.cells.length > 0) ? nextTRElement : null; currentCellIndexInRow = 0;
            });
        }

        function getAllEditorDataAsObject() {
            const data = {
                basicInfo: {
                    customerName: document.getElementById('customerName').value,
                    customerEmail: document.getElementById('customerEmail').value,
                    custcmail: document.getElementById('custcmail').value,
                    subject: document.getElementById('subject').value,
                    introText: document.getElementById('introText').value,
                    goodnm: document.getElementById('goodnm').value,
                },
                travelerInfoText: document.getElementById('travelerInfoText').value,
                quoteGroups: JSON.parse(JSON.stringify(quoteGroupDataStore)),
                contactInfo: {
                    empnm: document.getElementById('empnm').value,
                    empmail: document.getElementById('empmail').value,
                    emptel: document.getElementById('emptel').value,
                }
            };
            return data;
        }

        function restoreEditorFromData(data) {
            if (!data) {
                showToast("Î∂àÎü¨Ïò¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.", 3000, true);
                return;
            }

            if (data.basicInfo) {
                document.getElementById('customerName').value = data.basicInfo.customerName || '';
                document.getElementById('customerEmail').value = data.basicInfo.customerEmail || '';
                document.getElementById('custcmail').value = data.basicInfo.custcmail || '';
                document.getElementById('subject').value = data.basicInfo.subject || '';
                document.getElementById('introText').value = data.basicInfo.introText || '';
                document.getElementById('goodnm').value = data.basicInfo.goodnm || '';
            }

            document.getElementById('travelerInfoText').value = data.travelerInfoText || '';

            document.getElementById('quoteGroupsContainer').innerHTML = '';
            quoteGroupDataStore = {};
            quoteGroupCounter = 0;
            currentBorderColorIndex = 0;

            if (data.quoteGroups && typeof data.quoteGroups === 'object') {
                const sortedGroupKeys = Object.keys(data.quoteGroups).sort((a, b) => parseInt(a) - parseInt(b));

                sortedGroupKeys.forEach(originalGroupIndex => {
                    const groupData = data.quoteGroups[originalGroupIndex];
                    if (groupData) {
                        if (!groupData.detailedItinerary) groupData.detailedItinerary = { title: "Ïó¨Ìñâ ÏùºÏ†ïÌëú", days: [] };
                        if (!Array.isArray(groupData.detailedItinerary.days)) groupData.detailedItinerary.days = [];
                        groupData.detailedItinerary.days.forEach(day => {
                            if (!day.activities) day.activities = [];
                            day.activities.forEach(activity => { if (!activity.id) activity.id = generateId(); });
                            if (typeof day.isCollapsed === 'undefined') day.isCollapsed = true; // Default to collapsed for loaded data
                            if (typeof day.editingDate === 'undefined') day.editingDate = false;
                        });

                        createQuoteGroup(quoteGroupCounter, null, groupData);
                        quoteGroupCounter++;
                    }
                });
            }
            if (Object.keys(quoteGroupDataStore).length === 0) {
                createQuoteGroup(quoteGroupCounter++);
            }

            if (data.contactInfo) {
                document.getElementById('empnm').value = data.contactInfo.empnm || 'ÏûÑÏ∞ΩÏàú';
                document.getElementById('empmail').value = data.contactInfo.empmail || 'fire@naeiltour.co.kr';
                document.getElementById('emptel').value = data.contactInfo.emptel || '02-6262-5301';
            }
            showToast("Í≤¨Ï†ÅÏÑú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.");
        }

        function manualParseAndRestore(doc) {
            showToast("HTMLÏóêÏÑú Î∂ÄÎ∂ÑÏ†ÅÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏõêÌñàÏäµÎãàÎã§ (Ï†úÌïúÏ†Å Í∏∞Îä•).", 4000);
        }

        function generatePreviewHTML(isForFileSave = false) {
            let previewHTML = ``;
             previewHTML += `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${isForFileSave ? 'ÎÇ¥ÏùºÌà¨Ïñ¥ Í≤¨Ï†ÅÏÑú' : 'Í≤¨Ï†ÅÏÑú ÎØ∏Î¶¨Î≥¥Í∏∞'}</title>`;

            previewHTML += `<link href="https://cdn.tailwindcss.com/2.2.19/dist/tailwind.min.css" rel="stylesheet">`;
            previewHTML += `<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css">`;
            previewHTML += `<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">`;
            previewHTML += `<style>`;
            // Add base styles from current document, then override/add specific preview/saved styles
            document.querySelectorAll('style').forEach(styleTag => {
                // Exclude print-specific @page rules if not desired for file view directly
                if(!styleTag.innerHTML.includes("@page")){
                    previewHTML += styleTag.innerHTML;
                }
            });
            // Add styles to match the example file for saved/preview detailed itinerary
            previewHTML += `
                /* Styles to match example file's look and feel for detailed itinerary */
                body.preview-mode.saved-html-view, .saved-html-view body { /* Ensure high specificity */
                    font-family: 'Noto Sans KR', sans-serif;
                    background-color: #F8F9FA; /* Match example background */
                }
                .preview-mode .preview-container, .saved-html-view .preview-container {
                    max-width: 950px; /* Your original container max-width */
                    margin: 0 auto;
                    background-color: white;
                    padding: 1.5rem; /* Tailwind p-6 */
                    box-shadow: 0 0 10px rgba(0,0,0,0.1);
                    border-radius: 8px; /* Tailwind rounded-lg */
                }
                .saved-html-view .readonly-view-header {
                    background-color: white;
                    border-bottom: 1px solid #E0E0E0;
                    padding: 1rem;
                    text-align: center;
                }
                .saved-html-view .readonly-view-header h1 {
                    font-size: 1.5rem; /* text-2xl */
                    font-weight: bold;
                }
                .saved-html-view .readonly-main-content {
                    max-width: 48rem; /* max-w-3xl from example */
                    margin-left: auto;
                    margin-right: auto;
                    padding: 1rem; /* p-4 from example */
                }
                .saved-html-view .day-section {
                    margin-bottom: 16px;
                    border: 1px solid #E0E0E0; /* Match example */
                    border-radius: 0.375rem; /* rounded-md */
                    background-color: #ffffff;
                    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
                }
                .saved-html-view .day-header-container {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 12px 8px;
                    border-bottom: 1px solid #EEE;
                    background-color: #fdfdfd;
                    border-radius: 6px 6px 0 0;
                    cursor: pointer; /* Keep for saved HTML */
                }
                .saved-html-view .day-header-title {
                    font-size: 18px;
                    font-weight: 600;
                }
                .saved-html-view .day-header-controls .day-toggle-button-static {
                    display: inline-flex !important; /* Make sure this is visible in saved HTML */
                    padding: 0.25rem;
                }
                .saved-html-view .day-toggle-button-static svg {
                    width: 1.25rem; height: 1.25rem; color: #4B5563;
                }
                .saved-html-view .day-content-wrapper {
                    padding: 0 8px 8px 8px;
                }
                .saved-html-view .readonly-activity-card {
                    background-color: white;
                    border-radius: 8px;
                    border: 1px solid #E0E0E0;
                    padding: 16px;
                    margin-bottom: 16px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    display: flex;
                }
                .saved-html-view .card-time-icon-area { width: 100px; }
                .saved-html-view .card-icon { font-size: 24px; margin-bottom: 4px; }
                .saved-html-view .card-time { font-size: 14px; font-weight: bold; min-height: 21px; }
                .saved-html-view .card-image {
                    width: 100px !important; /* Match example */
                    height: 100px !important; /* Match example */
                    object-fit: cover !important;
                    border-radius: 4px;
                    margin-top: 8px;
                }
                .saved-html-view .readonly-collapse-button {
                    font-size: 0.75rem; color: #4B5563; padding: 0.25rem 0.5rem;
                    border: 1px solid #D1D5DB; border-radius: 0.375rem; cursor: pointer;
                    display: inline-block !important; /* Ensure visible */
                }
                .saved-html-view .readonly-collapse-button:hover { color: #1F2937; background-color: #F3F4F6; }

                /* Hide elements not relevant for pure preview/saved file */
                .saved-html-view .group-action-buttons, .saved-html-view .add-price-subgroup-button, /* etc. */
                .saved-html-view #addGlobalQuoteGroupBtn, .saved-html-view footer button, .saved-html-view footer input,
                .saved-html-view .itinerary-planner-styles .action-button-sm:not(.save-detailed-itinerary-html-btn):not(.save-detailed-day-html-btn), /* Keep save buttons for data-included version if logic desires */
                .saved-html-view .itinerary-planner-styles .edit-detailed-date-button, /* and other edit buttons */
                .saved-html-view .itinerary-planner-styles .card-actions-direct
                { display: none !important; }
            `;
            if (isPurePreview) { // If it's for a "preview-only" HTML file
                previewHTML += `
                .saved-html-view .itinerary-planner-styles .save-detailed-itinerary-html-btn,
                .saved-html-view .itinerary-planner-styles .save-detailed-day-html-btn {
                    display: none !important;
                }
                `;
            }

            previewHTML += `</style></head><body class="preview-mode saved-html-view">`;
            previewHTML += `<div class="preview-container">`;
            previewHTML += `<header class="mb-6 border-b pb-4 border-gray-200"><h1 class="text-3xl font-bold text-center" style="color: #000;">ÎÇ¥ÏùºÌà¨Ïñ¥ Ïó¨ÌñâÍ≤¨Ï†ÅÏÑú ${isForFileSave && !isPurePreview ? '' : (isForFileSave && isPurePreview ? '(ÎØ∏Î¶¨Î≥¥Í∏∞Ïö© Ï†ÄÏû•Î≥∏)' : '(ÎØ∏Î¶¨Î≥¥Í∏∞)')}</h1></header>`;


            // 1. Basic Info
            previewHTML += `<section class="mb-8"><h2 class="preview-section-title">Í∏∞Î≥∏ Ï†ïÎ≥¥</h2><div class="bg-gray-50 p-4 rounded">`;
            previewHTML += `<p><strong>Í≥†Í∞ùÎ™Ö:</strong> ${document.getElementById('customerName').value || 'N/A'}</p>`;
            previewHTML += `<p><strong>Ïù¥Î©îÏùº:</strong> ${document.getElementById('customerEmail').value || 'N/A'}</p>`;
            previewHTML += `<p><strong>Ï∞∏Ï°∞:</strong> ${document.getElementById('custcmail').value || 'N/A'}</p>`;
            previewHTML += `<p><strong>Î©îÏùºÏ†úÎ™©:</strong> ${document.getElementById('subject').value || 'N/A'}</p>`;
            previewHTML += `<p><strong>ÏïàÎÇ¥ÏÇ¨Ìï≠:</strong></p><div class="preview-textarea-content">${document.getElementById('introText').value.replace(/\n/g, '<br>') || 'N/A'}</div>`;
            previewHTML += `<p class="mt-2"><strong>ÏÉÅÌíàÎ™Ö (Í≥µÌÜµ):</strong> ${document.getElementById('goodnm').value || 'N/A'}</p>`;
            previewHTML += `</div></section>`;

            // 2. Traveler Info
            previewHTML += `<section class="mb-8"><h2 class="preview-section-title">ÏòàÏïΩÏûê Ï†ïÎ≥¥</h2><div class="bg-gray-50 p-4 rounded">`;
            previewHTML += `<div class="preview-textarea-content">${document.getElementById('travelerInfoText').value.replace(/\n/g, '<br>') || 'N/A'}</div>`;
            previewHTML += `</div></section>`;

            // 3. Quote Groups
            const groupKeys = Object.keys(quoteGroupDataStore).sort((a, b) => parseInt(a) - parseInt(b));
            groupKeys.forEach(groupIndex => {
                const groupData = quoteGroupDataStore[groupIndex];
                if (!groupData) return;

                previewHTML += `<section class="mb-8 p-4 border rounded" style="border-color: ${groupData.borderColor || '#ccc'}; border-width: 2px;">`;
                previewHTML += `<h3 class="preview-group-title" style="color: ${groupData.borderColor || '#333'};">${groupData.groupTitle || `Í≤¨Ï†Å Í∑∏Î£π ${parseInt(groupIndex) + 1}`}</h3>`;

                if (groupData.priceSubgroups && groupData.priceSubgroups.length > 0) {
                    previewHTML += `<div class="mb-6"><h4 class="preview-sub-group-title">ÏöîÍ∏à ÏïàÎÇ¥</h4>`;
                    groupData.priceSubgroups.forEach(subgroup => {
                        previewHTML += `<div class="mb-4">`;
                        if (subgroup.title) previewHTML += `<p class="font-semibold mb-1">${subgroup.title}</p>`;
                        previewHTML += `<table class="preview-table"><thead><tr><th>ÎÇ¥Ïó≠</th><th>1Ïù∏Îãπ Í∏àÏï°</th><th>Ïù∏Ïõê</th><th>Ï¥ù Í∏àÏï°</th><th>ÎπÑÍ≥†</th></tr></thead><tbody>`;
                        let subGrandTotal = 0;
                        subgroup.rows.forEach(row => {
                            const perPrice = parseFloat(row.perPrice) || 0;
                            const number = parseInt(row.number) || 0;
                            const rowTotal = perPrice * number;
                            subGrandTotal += rowTotal;
                            previewHTML += `<tr>
                                <td>${row.title || ''}</td><td class="text-right">${perPrice.toLocaleString()}</td>
                                <td class="text-center">${number}</td><td class="text-right">${rowTotal.toLocaleString()}</td>
                                <td>${row.bigo || ''}</td></tr>`;
                        });
                        previewHTML += `</tbody><tfoot><tr><td colspan="3" class="text-right font-bold">ÏÜåÍ≥Ñ</td><td class="text-right font-bold">${subGrandTotal.toLocaleString()}</td><td></td></tr></tfoot></table></div>`;
                    });
                    previewHTML += `</div>`;
                }

                previewHTML += `<div class="mb-6"><h4 class="preview-sub-group-title">Ìè¨Ìï®/Î∂àÌè¨Ìï® ÏÇ¨Ìï≠</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                previewHTML += `<div><h5 class="font-semibold mb-1">Ìè¨Ìï®</h5><div class="preview-textarea-content">${groupData.inclusionExclusion.includedTextarea.replace(/\n/g, '<br>') || 'N/A'}</div></div>`;
                previewHTML += `<div><h5 class="font-semibold mb-1">Î∂àÌè¨Ìï®</h5><div class="preview-textarea-content">${groupData.inclusionExclusion.excludedTextarea.replace(/\n/g, '<br>') || 'N/A'}</div></div>`;
                previewHTML += `</div></div>`;

                if (groupData.flightSubgroups && groupData.flightSubgroups.length > 0) {
                    previewHTML += `<div class="mb-6"><h4 class="preview-sub-group-title">Ìï≠Í≥µ Ïä§ÏºÄÏ§Ñ</h4>`;
                    groupData.flightSubgroups.forEach(subgroup => {
                        previewHTML += `<div class="mb-4">`;
                        if (subgroup.title) previewHTML += `<p class="font-semibold mb-1">${subgroup.title}</p>`;
                        previewHTML += `<table class="preview-table"><thead><tr><th>Ìé∏Î™Ö</th><th>Ï∂úÎ∞úÏùº</th><th>Ï∂úÎ∞úÏßÄ</th><th>Ï∂úÎ∞úÏãúÍ∞Ñ</th><th>ÎèÑÏ∞©Ïùº</th><th>ÎèÑÏ∞©ÏßÄ</th><th>ÎèÑÏ∞©ÏãúÍ∞Ñ</th></tr></thead><tbody>`;
                        subgroup.rows.forEach(row => {
                            previewHTML += `<tr><td>${row.flightNum || ''}</td><td>${row.depDate || ''}</td><td>${row.originCity || ''}</td><td>${row.depTime || ''}</td><td>${row.arrDate || ''}</td><td>${row.destCity || ''}</td><td>${row.arrTime || ''}</td></tr>`;
                        });
                        previewHTML += `</tbody></table></div>`;
                    });
                    previewHTML += `</div>`;
                }

                if (groupData.itinerarySummaryRows && groupData.itinerarySummaryRows.length > 0) {
                    previewHTML += `<div class="mb-6"><h4 class="preview-sub-group-title">Í∞ÑÎã®ÏùºÏ†ï</h4>`;
                    previewHTML += `<table class="preview-table"><thead><tr><th>ÏùºÏàò</th><th>ÎÇ†Ïßú</th><th>Ï∂úÎ∞úÏßÄ</th><th>ÎèÑÏ∞©ÏßÄ</th><th>ÏàôÎ∞ï</th><th>Ïù¥Îèô</th><th>ÎπÑÍ≥†</th></tr></thead><tbody>`;
                    groupData.itinerarySummaryRows.forEach(row => {
                        previewHTML += `<tr><td>${row.dayNo || ''}</td><td>${row.dayDate || ''}</td><td>${row.sCity || ''}</td><td>${row.eCity || ''}</td><td>${row.hotel || ''}</td><td>${row.traffic || ''}</td><td>${row.bigo || ''}</td></tr>`;
                    });
                    previewHTML += `</tbody></table></div>`;
                }

                if (groupData.detailedItinerary && groupData.detailedItinerary.days && groupData.detailedItinerary.days.length > 0) {
                    previewHTML += `<div class="mb-6">`; // Wrapper for the detailed itinerary block
                    previewHTML += generateReadOnlyHTMLViewForQuoteGroup(groupIndex);
                    previewHTML += `</div>`;
                } else {
                     previewHTML += `<div class="mb-6"><h4 class="preview-sub-group-title">ÏÉÅÌíàÏùºÏ†ï ÏÉÅÏÑ∏ (ÏùºÏ†ïÌëú)</h4><p>ÏÉÅÏÑ∏ ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.</p></div>`;
                }
                previewHTML += `</section>`;
            });

            previewHTML += `<section class="mb-8"><h2 class="preview-section-title">Îã¥ÎãπÏûê Ï†ïÎ≥¥</h2><div class="bg-gray-50 p-4 rounded">`;
            previewHTML += `<p><strong>Îã¥ÎãπÏûê:</strong> ${document.getElementById('empnm').value || 'N/A'}</p>`;
            previewHTML += `<p><strong>Îã¥ÎãπÏûêÎ©îÏùº:</strong> ${document.getElementById('empmail').value || 'N/A'}</p>`;
            previewHTML += `<p><strong>Ïó∞ÎùΩÏ≤ò:</strong> ${document.getElementById('emptel').value || 'N/A'}</p>`;
            previewHTML += `</div></section>`;
            previewHTML += `</div>`; // End .preview-container

            // Add the toggleDayView script directly into the generated HTML
            previewHTML += `
                <script>
                    function toggleDayView(headerElement) {
                        const contentWrapper = headerElement.nextElementSibling;
                        const toggleButtonSpan = headerElement.querySelector('.day-toggle-button-static svg'); // Target the SVG inside the span
                        if (contentWrapper && toggleButtonSpan) {
                            const isHidden = contentWrapper.classList.toggle('hidden');
                            // SVG paths for collapsed/expanded states (FontAwesome style chevrons)
                            const collapsedIconPath = "M9 5l7 7-7 7"; // fa-chevron-right like
                            const expandedIconPath = "M19 9l-7 7-7-7"; // fa-chevron-down like
                            
                            // Create a new path element or update existing one
                            let pathElement = toggleButtonSpan.querySelector('path');
                            if (!pathElement) { // If no path, create one (though it should exist from generateReadOnlyHTMLViewForQuoteGroup)
                                pathElement = document.createElementNS("http://www.w3.org/2000/svg", "path");
                                pathElement.setAttribute("stroke-linecap", "round");
                                pathElement.setAttribute("stroke-linejoin", "round");
                                pathElement.setAttribute("stroke-width", "2");
                                toggleButtonSpan.appendChild(pathElement);
                            }
                            pathElement.setAttribute("d", isHidden ? collapsedIconPath : expandedIconPath);
                        }
                    }
                <\/script>`;
            previewHTML += `</body></html>`;
            return previewHTML;
        }


        function previewQuote() {
            const previewHtmlContent = generatePreviewHTML(false); // false means it's for a popup window, not a file save
            const previewWindow = window.open('', '_blank');
            if (previewWindow) {
                previewWindow.document.open();
                previewWindow.document.write(previewHtmlContent);
                previewWindow.document.close();
                previewWindow.focus();
            } else {
                alert('ÌåùÏóÖ Ï∞®Îã® Í∏∞Îä•Ïù¥ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÎØ∏Î¶¨Î≥¥Í∏∞Î•º Ïó¥ Ïàò ÏóÜÏäµÎãàÎã§. ÌåùÏóÖ Ï∞®Îã®ÏùÑ Ìï¥Ï†úÌï¥Ï£ºÏÑ∏Ïöî.');
            }
        }

        function downloadGeneratedHTML(isPurePreview = false) {
            const mainContainer = document.querySelector('body > .container');
            if (!mainContainer) {
                showToast("Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", 3000, true);
                return;
            }

            let finalHtmlString = generatePreviewHTML(true); // true indicates it's for file saving context
            const customerName = document.getElementById('customerName').value.trim() || 'Í≥†Í∞ùÎãò';
            let fileName = `ÎÇ¥ÏùºÌà¨Ïñ¥_Í≤¨Ï†ÅÏÑú_${customerName.replace(/[^a-z0-9Í∞Ä-Ìû£]/gi, '_')}_${new Date().toISOString().slice(0,10)}`;


            if (!isPurePreview) {
                const fullDataToEmbed = getAllEditorDataAsObject();
                const safeDataString = JSON.stringify(fullDataToEmbed).replace(/<\/script>/g, '<\\/script>');
                const dataScript = `<script type="application/json" id="fullQuoteData">${safeDataString}<\/script>`;
                finalHtmlString = finalHtmlString.replace('</body>', `${dataScript}</body>`);
                fileName += "_Îç∞Ïù¥ÌÑ∞Ìè¨Ìï®.html";
                showToast('Í≤¨Ï†ÅÏÑúÍ∞Ä HTML ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§. (Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®)');
            } else {
                fileName += "_ÎØ∏Î¶¨Î≥¥Í∏∞Ïö©.html";
                showToast('ÎØ∏Î¶¨Î≥¥Í∏∞Ïö© Í≤¨Ï†ÅÏÑúÍ∞Ä HTML ÌååÏùºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
            }


            const blob = new Blob([finalHtmlString], { type: 'text/html;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        // getMobileStylesForDownload is no longer strictly needed as styles are embedded in generatePreviewHTML
        // but can be kept if there's a desire to manage styles separately for other purposes.
        function getMobileStylesForDownload() {
            let styles = "";
            // ... (implementation as before if needed, or can be removed/simplified) ...
            return styles;
        }

    </script>
</body>
</html>
